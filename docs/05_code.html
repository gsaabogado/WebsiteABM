<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.36">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>The ABM Model of Technology Adoption (ABM-REN) - Model Code</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">The ABM Model of Technology Adoption (ABM-REN)</span>
  </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./01_about.html" aria-current="page">Home</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/gsaabogado"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/gsaabogado"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://luissarmiento.net/">Personal Site</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Model Code</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Sections</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_about.html" class="sidebar-item-text sidebar-link">About</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_data.html" class="sidebar-item-text sidebar-link">Data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_theory.html" class="sidebar-item-text sidebar-link">Theoretical Background</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_model.html" class="sidebar-item-text sidebar-link">Model Overview</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_code.html" class="sidebar-item-text sidebar-link active">Model Code</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#generate-electricity-price" id="toc-generate-electricity-price" class="nav-link active" data-scroll-target="#generate-electricity-price">Generate Electricity Price</a></li>
  <li><a href="#set-policy" id="toc-set-policy" class="nav-link" data-scroll-target="#set-policy">Set Policy</a></li>
  <li><a href="#income-and-power-cost" id="toc-income-and-power-cost" class="nav-link" data-scroll-target="#income-and-power-cost">Income and Power cost</a></li>
  <li><a href="#income-groups" id="toc-income-groups" class="nav-link" data-scroll-target="#income-groups">Income Groups</a></li>
  <li><a href="#consumption-and-saving" id="toc-consumption-and-saving" class="nav-link" data-scroll-target="#consumption-and-saving">Consumption and saving</a></li>
  <li><a href="#augment-panel-age" id="toc-augment-panel-age" class="nav-link" data-scroll-target="#augment-panel-age">Augment panel age</a></li>
  <li><a href="#expectations-formation" id="toc-expectations-formation" class="nav-link" data-scroll-target="#expectations-formation">Expectations formation</a></li>
  <li><a href="#adoption-decision" id="toc-adoption-decision" class="nav-link" data-scroll-target="#adoption-decision">Adoption Decision</a></li>
  <li><a href="#calculate-statistics" id="toc-calculate-statistics" class="nav-link" data-scroll-target="#calculate-statistics">Calculate statistics</a></li>
  <li><a href="#main-model-function" id="toc-main-model-function" class="nav-link" data-scroll-target="#main-model-function">Main model function</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Model Code</h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<p>The model is written in Python. Below we provide a step-by-step documentation of all model functions. In total the model consists of 9 separate functions which are in turn called by one main model function containing the initialisation and the main simulation loop, which we describe last.</p>
<section id="generate-electricity-price" class="level2">
<h2 class="anchored" data-anchor-id="generate-electricity-price">Generate Electricity Price</h2>
<p>This function is called once at the beginning of a simulation run in order to generate a time-series of the electricity price which agents have to pay at each time-step of the simulation (note that this is different from the expected future electricity price, described below). As explained in the model description section, this electricity price is generated by simulating an AR(1) model estimated on electricity price data for Germany.</p>
<p>The function takes two inputs, namely <code>Params</code>, which is a pandas dataframe containing the names and values of the model parameters and <code>length</code>, an integer denoting the length of the time-series to be created (given by simulation length+2 since we need two lagged values at the beginning for the expectations formation process discussed below).</p>
<p>The function then creates a numpy vector of zeros of size <code>length</code>. The first element of the vector is set to the initial electricity price taken from <code>Params</code>, while the second is set to the initial price plus the trend component, i.e.&nbsp;the intercept from the AR(1) model. All subsequent elements are then generated by iterating the AR(1) model forward, including a normally distributed random shock the standard deviation of which is taken from the standard deviation of the residuals from the estimation of the AR(1) model. Finally, the function returns the time-series of the electricity price.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> GenerateElectricityPrice(Params,length):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector of zeros</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    electricityprice<span class="op">=</span>np.zeros(length)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#First element equal to initial price</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    electricityprice[<span class="dv">0</span>]<span class="op">=</span>Params[<span class="st">"ElectricityPriceInit"</span>].values[<span class="dv">0</span>]</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Second element equal to initial price plus intercept from AR(1) model</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    electricityprice[<span class="dv">1</span>]<span class="op">=</span>electricityprice[<span class="dv">0</span>]<span class="op">+</span>Params[<span class="st">"ElectricityPriceTrend"</span>].values[<span class="dv">0</span>]</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Iterate over rest of vector</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>,length):</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Generate normally distributed shock based on standard deviation of regression residuals</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        shock<span class="op">=</span>Params[<span class="st">"ElectricityPriceSD"</span>].values[<span class="dv">0</span>]<span class="op">*</span>np.sqrt(<span class="op">-</span><span class="dv">2</span><span class="op">*</span>np.log(np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>)))<span class="op">*</span>np.cos(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Price in t calculated by iterating AR(1) model</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        electricityprice[t]<span class="op">=</span>electricityprice[t<span class="op">-</span><span class="dv">1</span>]<span class="op">+</span>Params[<span class="st">"ElectricityPriceTrend"</span>].values[<span class="dv">0</span>]<span class="op">+</span>Params[<span class="st">"ElectricityPriceAR"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(electricityprice[t<span class="op">-</span><span class="dv">1</span>]<span class="op">-</span>electricityprice[t<span class="op">-</span><span class="dv">2</span>])<span class="op">+</span>shock</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Return the vector of prices</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> electricityprice</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-policy" class="level2">
<h2 class="anchored" data-anchor-id="set-policy">Set Policy</h2>
<p>Depending on the values of various dummies in the <code>Params</code> dataframe and the current simulation period, this function determines whether a policy experiment should be activated in the current period.</p>
<p>At present, the model includes four possible policies, namely a subsidy on the cost of a solar panel (<code>Subsidy1</code>), a subsidy on the price at which electricity generated by PV can be sold to the grid (<code>Subsidy2</code>), a policy increasing the maximum permitted loan to value ratio for bank loans to acquire PV (<code>CreditPolicy1</code>, currently not used since in the baseline the maximum LTV is already set to 1), and a policy increasing the maximum allowed debt service to income ratio resulting from a loan made to acquire PV (<code>CreditPolicy2</code>). For instance, if the dummy <code>Subsidy1</code> is set to 1 and if the current simulation period (expressed as a year) is equal to or larger than <code>SubsidyStart</code>, a subsidy on the installation cost of PV will be activated. The function checks the conditions for the respective policy variables in each period, changes them if necessary, and then returns them.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> SetPolicy(Subsidy1,Subsidy2,CreditPolicy1,CreditPolicy2,year,Params):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> Params[<span class="st">"Subsidy1"</span>].values[<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span> year<span class="op">&gt;=</span>Params[<span class="st">"SubsidyStart"</span>].values[<span class="dv">0</span>]:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        Subsidy1<span class="op">=</span>Params[<span class="st">"s1"</span>].values[<span class="dv">0</span>]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> Params[<span class="st">"Subsidy2"</span>].values[<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span> year<span class="op">&gt;=</span>Params[<span class="st">"SubsidyStart"</span>].values[<span class="dv">0</span>]:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        Subsidy2<span class="op">=</span>Params[<span class="st">"s2"</span>].values[<span class="dv">0</span>]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> Params[<span class="st">"CreditPolicy1"</span>].values[<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span> year<span class="op">&gt;=</span>Params[<span class="st">"CreditPolicyStart"</span>].values[<span class="dv">0</span>]:</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        CreditPolicy1<span class="op">=</span>Params[<span class="st">"cp1"</span>].values[<span class="dv">0</span>]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> Params[<span class="st">"CreditPolicy2"</span>].values[<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span> year<span class="op">&gt;=</span>Params[<span class="st">"CreditPolicyStart"</span>].values[<span class="dv">0</span>]:</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        CreditPolicy2<span class="op">=</span>Params[<span class="st">"cp2"</span>].values[<span class="dv">0</span>]</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[Subsidy1,Subsidy2,CreditPolicy1,CreditPolicy2]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="income-and-power-cost" class="level2">
<h2 class="anchored" data-anchor-id="income-and-power-cost">Income and Power cost</h2>
<p>This function generates the random incomes and electricity costs for each agent in every period. <code>Income_f</code> and <code>Powercost_f</code> are vectors of length <em>N</em>, where <em>N</em> is the number of agents in the model. The deterministic mean value of income and power cost for each agent is assumed to grow at rate <code>Trend</code> (which may be heterogeneous across agents) at each time step. We then draw the actual income and power cost for each agent in the current period using uniform draws which are then transformed into draws from a normal distribution with means <code>Income_f</code> and <code>Powercost_f</code> respectively and standard deviations <code>Income_sd</code> and <code>Powercost_sd</code> respectively. Both income and power cost are constrained to be positive for each agent.</p>
<p>If an agent owns PV (such that <code>PV[n]==1</code>), the amount it has to pay for electricity is reduced by the capacity of the panel times the current electricity price, including a subsidy if <code>Subsidy2&gt;0</code> (see above). Finally, we also calculate <code>income_p</code>, a measure of income net of electricity cost for each agent.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> IncomePowercost(Income_f,Trend,Powercost_f,Income_sd,Powercost_sd,PV,Price,Subsidy2,Params):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Means of distributions for income and electricity cost are increased by trend component</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    Income_f<span class="op">=</span>Income_f<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>Trend)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    Powercost_f<span class="op">=</span>Powercost_f<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>Trend)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Draw uniform random numbers</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    randincome<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,Income_f.size)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    randincome2<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,Income_f.size)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    randpowercost<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,Powercost_f.size)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    randpowercost2<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,Powercost_f.size)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Convert uniform to normal with the appropriate means and standard deviations</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    randincome<span class="op">=</span>np.sqrt(<span class="op">-</span><span class="dv">2</span><span class="op">*</span>np.log(randincome))<span class="op">*</span>np.cos(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>randincome2)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    randpowercost<span class="op">=</span>np.sqrt(<span class="op">-</span><span class="dv">2</span><span class="op">*</span>np.log(randpowercost))<span class="op">*</span>np.cos(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>randpowercost2)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    randincome<span class="op">=</span>Income_sd<span class="op">*</span>randincome<span class="op">*</span>Income_f<span class="op">+</span>Income_f</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    randincome<span class="op">=</span>np.maximum(<span class="fl">1e-10</span>,randincome)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    randpowercost<span class="op">=</span>Powercost_sd<span class="op">*</span>randpowercost<span class="op">*</span>Powercost_f<span class="op">+</span>Powercost_f</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    randpowercost<span class="op">=</span>np.maximum(<span class="fl">1e-10</span>,randpowercost)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Reduce electricity cost of PV owners</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    randpowercost<span class="op">=</span>(randpowercost<span class="op">-</span>PV<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>Subsidy2)<span class="op">*</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>])<span class="op">*</span>Price</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate income net of electricity cost</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    income_p<span class="op">=</span>randincome<span class="op">-</span>randpowercost</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Return income, electricity cost, and income net of electricity cost</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[randincome,randpowercost,income_p]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="income-groups" class="level2">
<h2 class="anchored" data-anchor-id="income-groups">Income Groups</h2>
<p>The purpose of this function is to calculate income distribution statistics, as well as the rates of PV ownership by income decile, which are used in other parts of the model. We begin by sorting <code>Income_p</code>, the vector containing income net of electricity cost, in ascending order. Next, we set the cut-off points for income deciles and percentiles using the vectors <code>Positions_p</code> and <code>Positions_d</code>, which are calculated during the initialisation phase (described below) based on the number of agents in the model and give the number of agents in each decile/percentile. Next we iterate over all deciles and percentiles, assinging to each agent their income decile/percentile based on their current income net of electricity cost and, for deciles, also recording the number of decile members who have PV, which is in turn used to calculate PV ownership rates by income decile.</p>
<p>The function returns three vectors. <code>IncomePercentiles</code> and <code>IncomeDeciles</code> are vectors of length <em>N</em>, in which each element gives the income percentile/decile of the respective agent. <code>PVOwnershipDeciles</code> is a vector of length 10 which gives the PV ownership rates for each decile.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> IncomeGroups(Income_p,PV,Positions_p,Percentiles,Positions_d,Deciles,IncomePercentiles,IncomeDeciles,PVOwnershipDeciles,DecileMembers):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Sort income net of electricity cost in ascending order</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    income_psorted<span class="op">=</span>np.sort(Income_p)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Based on sorted income and number of agents in each decile/percentile, set cut-off points</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    Percentiles[<span class="dv">0</span>:<span class="dv">99</span>]<span class="op">=</span>income_psorted[Positions_p]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    Percentiles[<span class="dv">99</span>]<span class="op">=</span>income_psorted[((income_psorted.size)<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    Deciles[<span class="dv">0</span>:<span class="dv">9</span>]<span class="op">=</span>income_psorted[Positions_d]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    Deciles[<span class="dv">9</span>]<span class="op">=</span>income_psorted[((income_psorted.size)<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise vectors to 0</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    IncomeDeciles[:]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    IncomePercentiles[:]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    PVOwnershipDeciles[:]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    DecileMembers[:]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Iterate over deciles</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Determine which agents belong to decile i</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>            members<span class="op">=</span>np.where(Income_p<span class="op">&lt;=</span>Deciles[i])</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>            members<span class="op">=</span>np.where((Income_p<span class="op">&lt;=</span>Deciles[i]) <span class="op">&amp;</span> (Income_p<span class="op">&gt;</span>Deciles[(i<span class="op">-</span><span class="dv">1</span>)]))</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set decile of all members to i</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        IncomeDeciles[members]<span class="op">=</span>i</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Number of agents in decile i</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        DecileMembers[i]<span class="op">=</span>members[<span class="dv">0</span>].size</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Number of PV owners in decile i</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        PVOwnershipDeciles[i]<span class="op">=</span>PV[members[<span class="dv">0</span>]].<span class="bu">sum</span>()</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Iterate over percentiles</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Determine which agents belong to percentile i</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>            members<span class="op">=</span>np.where(Income_p<span class="op">&lt;=</span>Percentiles[i])</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>            members<span class="op">=</span>np.where((Income_p<span class="op">&lt;=</span>Percentiles[i]) <span class="op">&amp;</span> (Income_p<span class="op">&gt;</span>Percentiles[(i<span class="op">-</span><span class="dv">1</span>)]))</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set percentile of all members to i</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        IncomePercentiles[members]<span class="op">=</span>i</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate PV ownership rates by decile</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    PVOwnershipDeciles<span class="op">/=</span>DecileMembers</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Return vectors containing income decile/percentile of each agent and PV ownership rate by decile</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[IncomePercentiles,IncomeDeciles,PVOwnershipDeciles]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="consumption-and-saving" class="level2">
<h2 class="anchored" data-anchor-id="consumption-and-saving">Consumption and saving</h2>
<p>This function determines agents’ consumption and saving. In addition, agents with positive outstanding debt make debt service payments. The main purpose of this is to update agents’ <code>Liquidity</code> , i.e.&nbsp;their stock of liquid assets (money) which can be used to buy PV.</p>
<p>The function begins by setting a consumption propensity out of income net of electricity cost for each agent based on their current income percentile. From this, their desired consumption is determined, including a persistence component. Income, electricity cost and desired consumption are then used to calculate the desired saving of each agent. If an agent cannot finance their desired consumption and electricity cost using current income and accumulated liquid assets, their actual consumption is implicitly curtailed such that their liquidity does not become negative (since we assume that households cannot borrow for consumption but only to acquire PV).</p>
<p>Next, agents with positive debt make debt service payments, which are divided into principal payments (which reduce the stock of outstanding debt) and interest payments. Any interest payments which agents cannot afford are added to their balance of outstanding debt and their debt service payments for the following periods are updated accordingly. Agents whose debt has become zero in the current period (i.e.&nbsp;they have paid off their full loan) have their interest rate and debt service payments set to zero.</p>
<p>Finally, if an agent has positive saving after debt service in the current period, their liquidity is updated by a fraction of that increment. This fraction is based on the agent’s current income decile and reflects the share of financial wealth held as liquid assets by income group.</p>
<p>The function returns agents’ updated current liquidity, debt, debt service payments, loan interest rates and <em>desired</em> consumption (the latter is used in the next period to calculate the persistence component of desired consumption).</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ConsumptionSaving(Income_p,Propensities,IncomePercentiles,Consumption,Income,Powercost,Liquidity,Debt,DebtService,LoanRate,PanelAge,LiquidityShares,Params,period):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Determine agents' consumption propensities out of income net of electricity cost based on their current income percentile</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    consshares<span class="op">=</span>Propensities[IncomePercentiles.astype(<span class="bu">int</span>)]</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Determine agents' current desired consumption</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> period<span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        Consumption[:]<span class="op">=</span>consshares<span class="op">*</span>Income_p</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">#If simulation period&gt;0, take into account persistence in desired consumption</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        Consumption[:]<span class="op">=</span>Params[<span class="st">"PersistenceConsumption"</span>].values[<span class="dv">0</span>]<span class="op">*</span>Consumption[:]<span class="op">+</span>(<span class="dv">1</span><span class="op">-</span>Params[<span class="st">"PersistenceConsumption"</span>].values[<span class="dv">0</span>])<span class="op">*</span>consshares<span class="op">*</span>Income_p</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents' desired saving is Income (including electricity cost!) minus (desired) consumption minus electricity cost</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    saving<span class="op">=</span>Income<span class="op">-</span>Consumption<span class="op">-</span>Powercost</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Save pre-consumption liquidity (stock of money) of each agent</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    Liquidity_p<span class="op">=</span>Liquidity</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#If liquidity and income are greater than consumption plus electricity cost, update liquidity using saving (which may be negative!)</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    Liquidity[(Liquidity<span class="op">+</span>Income)<span class="op">&gt;=</span>(Consumption<span class="op">+</span>Powercost)]<span class="op">+=</span>saving[(Liquidity<span class="op">+</span>Income)<span class="op">&gt;=</span>(Consumption<span class="op">+</span>Powercost)]</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Otherwise, liquidity is set to 0; consumption is implicitly reduced to ensure liquidity does not become negative</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    Liquidity[(Liquidity<span class="op">+</span>Income)<span class="op">&lt;</span>(Consumption<span class="op">+</span>Powercost)]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Determine debt service for agents with positive debt</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    DebtService[Debt<span class="op">&gt;</span><span class="dv">0</span>]<span class="op">=</span>np.minimum(DebtService[Debt<span class="op">&gt;</span><span class="dv">0</span>],Debt[Debt<span class="op">&gt;</span><span class="dv">0</span>])</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Decompose debt service into interest and principal component</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    interest<span class="op">=</span>LoanRate<span class="op">*</span>Debt</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    principal<span class="op">=</span>DebtService<span class="op">-</span>interest</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update remaining term of loan</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    term<span class="op">=</span>np.maximum(<span class="dv">1</span>,Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]<span class="op">-</span>PanelAge)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Principal is paid if agent can afford to do so; debt is reduced</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    Debt[Liquidity<span class="op">&gt;=</span>DebtService]<span class="op">-=</span>principal[Liquidity<span class="op">&gt;=</span>DebtService]</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who cannot afford full principal pay as much as they can</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    Debt[(Liquidity<span class="op">&gt;=</span>interest) <span class="op">&amp;</span> (Liquidity<span class="op">&lt;</span>DebtService)]<span class="op">-=</span>Liquidity[(Liquidity<span class="op">&gt;=</span>interest) <span class="op">&amp;</span> (Liquidity<span class="op">&lt;</span>DebtService)]</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Any unpaid interest is added to outstanding debt</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    Debt[Liquidity<span class="op">&lt;</span>interest]<span class="op">+=</span>interest[Liquidity<span class="op">&lt;</span>interest]<span class="op">-</span>Liquidity[Liquidity<span class="op">&lt;</span>interest]</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Find agents who did not fully service debt</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    adjustservice<span class="op">=</span>np.where(Liquidity<span class="op">&lt;</span>DebtService)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update liquidity based on debt service made</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    Liquidity[Liquidity<span class="op">&lt;</span>DebtService]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    Liquidity[Liquidity<span class="op">&gt;=</span>DebtService]<span class="op">-=</span>DebtService[Liquidity<span class="op">&gt;=</span>DebtService]</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Adjust debt service of agents who did not pay full debt service</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    DebtService[adjustservice]<span class="op">=</span>Debt[adjustservice]<span class="op">*</span>(LoanRate[adjustservice]<span class="op">*</span>np.power((<span class="dv">1</span><span class="op">+</span>LoanRate[adjustservice]),term[adjustservice]))<span class="op">/</span>(np.power((<span class="dv">1</span><span class="op">+</span>LoanRate[adjustservice]),term[adjustservice])<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set loan rate, debt service and debt of agents who have paid off their loans to 0 (&lt;=0) is used here since rounding errors can lead to slightly negative debt</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    LoanRate[Debt<span class="op">&lt;=</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    DebtService[Debt<span class="op">&lt;=</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    Debt[Debt<span class="op">&lt;=</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update liquidity based on shares of savings going into liquid assets by income percentile</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    shares<span class="op">=</span>LiquidityShares[IncomePercentiles.astype(<span class="bu">int</span>)]</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    Liquidity[Liquidity<span class="op">&gt;</span>Liquidity_p]<span class="op">=</span>Liquidity_p[Liquidity<span class="op">&gt;</span>Liquidity_p]<span class="op">+</span>shares[Liquidity<span class="op">&gt;</span>Liquidity_p]<span class="op">*</span>(Liquidity[Liquidity<span class="op">&gt;</span>Liquidity_p]<span class="op">-</span>Liquidity_p[Liquidity<span class="op">&gt;</span>Liquidity_p])</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Return agents' current liquidity, debt, debt service, loan rate and consumption</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[Liquidity,Debt,DebtService,LoanRate,Consumption]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="augment-panel-age" class="level2">
<h2 class="anchored" data-anchor-id="augment-panel-age">Augment panel age</h2>
<p>This short function augments the age of all solar panels in the model by one period. If the panel of an agent has reached its maximum age, the value of <code>PV</code> is set to zero for that agent, as is the value of <code>PanelAge</code>. The agent is then no longer a PV owner and will face the adoption decision again. The function returns the updated vectors of PV ownership and panel ages.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> AugmentPanelAge(PV,PanelAge,Params):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    PanelAge[PV<span class="op">==</span><span class="dv">1</span>]<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    PV[PanelAge<span class="op">&gt;</span>Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    PanelAge[PanelAge<span class="op">&gt;</span>Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[PanelAge,PV]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="expectations-formation" class="level2">
<h2 class="anchored" data-anchor-id="expectations-formation">Expectations formation</h2>
<p>This function is used to generate a time-series of expected future electricity prices for each agents. These are needed below when agents decide whether or not to adopt PV.</p>
<p>Expectations formation of our bounded rational agents takes place using the well-established recursive least squares algorithm. Each agent has their own “internal” AR(1) model of the electricity price, the coefficients of which they update in every period using the latest observation of the actual electricity price in the model. Importantly, each agent uses an individual gain parameter to update their estimations, such that expected electricity prices differ across agents. In particular, agents with a high gain parameter will tend to update their estimated coefficients more strongly in reaction to new information, while agents with a low gain parameter will react less.</p>
<p>The first part of the function updates the internal AR(1) models of the agents, while the second projects the models to generate time-series of a length equal to the maximum lifespan of a solar panel. The function then returns the coefficients variance-covariance matrices of the updated AR(1) models and the time-series of expected prices.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> FormExpectation(ARPars,ARMats,Price,Gain,ExpectedPrice,period):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate vector of independent variables --&gt; constant=1 and current change in price</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    independent<span class="op">=</span>np.array([[<span class="dv">1</span>],[(Price[(period<span class="op">+</span><span class="dv">1</span>)]<span class="op">-</span>Price[period])]])</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update variance-covariance matrices following recursive least squares algorithm</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    mat1<span class="op">=</span>np.dot(independent,independent.transpose())</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    ARMatsNew<span class="op">=</span>ARMats<span class="op">+</span>Gain[:,<span class="va">None</span>,<span class="va">None</span>]<span class="op">*</span>(mat1<span class="op">-</span>ARMats)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Test for singularity of updated matrices</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    test<span class="op">=</span>np.linalg.det(ARMatsNew)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="bu">sum</span>(test<span class="op">==</span><span class="dv">0</span>)<span class="op">&gt;</span><span class="dv">0</span>):</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'One or more matrices are singular!'</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#If updated matrix of an agent is singular, use old matrix</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    ARMats[np.where(test<span class="op">!=</span><span class="dv">0</span>)]<span class="op">=</span>ARMatsNew[np.where(test<span class="op">!=</span><span class="dv">0</span>)]</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update coefficient estimates of agents' AR(1) models</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    transposes<span class="op">=</span>ARPars.swapaxes(<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    result1<span class="op">=</span>np.dot(transposes,independent)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    dependent<span class="op">=</span>Price[(period<span class="op">+</span><span class="dv">2</span>)]<span class="op">-</span>Price[(period<span class="op">+</span><span class="dv">1</span>)]</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    result1<span class="op">=</span>dependent<span class="op">-</span>result1</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    result1<span class="op">=</span>independent<span class="op">*</span>result1</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    result1<span class="op">=</span>np.linalg.solve(ARMats,result1)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    ARPars<span class="op">+=</span>Gain[:,<span class="va">None</span>,<span class="va">None</span>]<span class="op">*</span>result1</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    transposes1<span class="op">=</span>ARPars[:,<span class="dv">0</span>].transpose()</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    transposes2<span class="op">=</span>ARPars[:,<span class="dv">1</span>].transpose()</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate time-series of expected electricity price for each agent</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    ExpectedPrice[:,<span class="dv">0</span>]<span class="op">=</span>(Price[(period<span class="op">+</span><span class="dv">2</span>)]<span class="op">+</span>ARPars[:,<span class="dv">0</span>]<span class="op">+</span>ARPars[:,<span class="dv">1</span>]<span class="op">*</span>(Price[(period<span class="op">+</span><span class="dv">2</span>)]<span class="op">-</span>Price[(period<span class="op">+</span><span class="dv">1</span>)])).transpose()</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    ExpectedPrice[:,<span class="dv">1</span>]<span class="op">=</span>ExpectedPrice[:,<span class="dv">0</span>]<span class="op">+</span>transposes1<span class="op">+</span>transposes2<span class="op">*</span>(ExpectedPrice[:,<span class="dv">0</span>]<span class="op">-</span>Price[(period<span class="op">+</span><span class="dv">2</span>)])</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>,<span class="bu">len</span>(ExpectedPrice[<span class="dv">0</span>])):</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        ExpectedPrice[:,t]<span class="op">=</span>ExpectedPrice[:,(t<span class="op">-</span><span class="dv">1</span>)]<span class="op">+</span>transposes1<span class="op">+</span>transposes2<span class="op">*</span>(ExpectedPrice[:,(t<span class="op">-</span><span class="dv">1</span>)]<span class="op">-</span>ExpectedPrice[:,(t<span class="op">-</span><span class="dv">2</span>)])</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Return components of updated AR(1) models and the time-series of expected prices</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[ARMats,ARPars,ExpectedPrice]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="adoption-decision" class="level2">
<h2 class="anchored" data-anchor-id="adoption-decision">Adoption Decision</h2>
<p>In this function, agents who do not yet own PV decide whether or not to purchase a panel.</p>
<p>The function first checks which agents would need a loan in order to adopt PV (namely those who do not have sufficient liquid assets to buy one outright). Based on the size of the loan needed, agents may be credit rationed if the resulting loan to value ratio exceeds the maximum permitted level (note that in the current implementation, <code>Params["MaxLTV"]=1</code> such that this rationing mechanism is effectively switched off).</p>
<p>Next, the bank proposes a loan interest rate to every agent with positive borrowing needs based on the size of the required loan. From this, in turn, we calculate the size of the implied debt service payment. If the prospective debt service payment of an agent exceeds a certain fraction (<code>Params["MaxDTI"]</code>) of their current income, the agent is credit rationed. Since the model only includes a single type of solar panel with a given installation cost, credit rationed agents cannot adopt (i.e.&nbsp;they cannot, for instance, buy a smaller panel with a smaller loan).</p>
<p>The function then calculates, for each agent, a sum of expected discounted revenue from owning PV over the lifetime of a panel, based on agents’ expected electricity prices, as well as a sum of discounted future loan costs based on the size of the needed loan and the interest rate proposed by the bank. From this, an expected profit from adopting PV is derived.</p>
<p>This expected profit, in turn, feeds into the expected utility from adopting PV. In addition to profit, this utility also contains a component related to social influence (based on the share of other agents in a given agent’s income decile who have already adopted PV) and one related to environmental attitude.</p>
<p>Agents for whom expected utility is positive purchase a solar panel and their liquidity, debt, debt service payments and loan rates are updated accordingly. The function then returns the updated vectors of PV ownership, credit rationing, liquidity, loan rates, debt stocks and debt service payments.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> AdoptionDecision(PV,Feasible,Liquidity,Rationed,Debt,Income,ExpectedPrice,Discount,Revenue,LoanCost,PVOwnershipDeciles,IncomeDeciles,LoanRate,DebtService,Influence,Attitude,Subsidy1,Subsidy2,CreditPolicy1,CreditPolicy2,Params):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Determine size of loan needed to purchase PV (installation cost minus stock of money held)</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    loanneeded<span class="op">=</span>(<span class="dv">1</span><span class="op">-</span>Subsidy1)<span class="op">*</span>Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>]<span class="op">-</span>Liquidity</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who already have PV do not need a loan</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    loanneeded[PV<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who have sufficient money to buy outright do not need a loan</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    loanneeded[(PV<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (Liquidity<span class="op">&gt;=</span>((<span class="dv">1</span><span class="op">-</span>Subsidy1)<span class="op">*</span>Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>]))]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents on whose dwelling PV is not feasible do not need a loan</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    loanneeded[Feasible<span class="op">==</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Check credit rationing condition based on loan to value ratio</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    Rationed[(loanneeded<span class="op">+</span>Debt)<span class="op">&gt;</span>((<span class="dv">1</span><span class="op">-</span>Subsidy1)<span class="op">*</span>Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(Params[<span class="st">"MaxLTV"</span>].values[<span class="dv">0</span>]<span class="op">+</span>CreditPolicy1))]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Based on loan needed, calculate loan rate proposed by the bank</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    proposedrate<span class="op">=</span>Params[<span class="st">"BaseRate"</span>].values[<span class="dv">0</span>]<span class="op">+</span>Params[<span class="st">"InterestMarkup"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>loanneeded<span class="op">/</span>((<span class="dv">1</span><span class="op">-</span>Subsidy1)<span class="op">*</span>Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>]<span class="op">*</span>Params[<span class="st">"MaxLTV"</span>].values[<span class="dv">0</span>]))</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Based on proposed rate, calculate implied debt service payment</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    payment<span class="op">=</span>loanneeded<span class="op">*</span>(proposedrate<span class="op">*</span>(np.power(<span class="dv">1</span><span class="op">+</span>proposedrate,Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>])))<span class="op">/</span>((np.power(<span class="dv">1</span><span class="op">+</span>proposedrate,Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]))<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Check credit rationing condition based on debt service to income ratio</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    Rationed[(payment<span class="op">/</span>Income)<span class="op">&gt;</span>(Params[<span class="st">"MaxDTI"</span>].values[<span class="dv">0</span>]<span class="op">+</span>CreditPolicy2)]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who do not need a loan, for whom PV is technically infeasible or who already have PV are not rationed</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    Rationed[loanneeded<span class="op">==</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    Rationed[Feasible<span class="op">==</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    Rationed[PV<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate the discounted sums of expected revenue from PV and loan cost for each agent using expected future electricity prices</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    Revenue[:]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    LoanCost[:]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    balanceremaining<span class="op">=</span>loanneeded</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]):</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        Revenue<span class="op">+=</span>ExpectedPrice[:,t]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>Subsidy2)<span class="op">*</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">/</span>(np.power(<span class="dv">1</span><span class="op">+</span>Discount,t))</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        cost<span class="op">=</span>proposedrate<span class="op">*</span>balanceremaining</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        balanceremaining<span class="op">-=</span>(payment<span class="op">-</span>cost)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        LoanCost<span class="op">+=</span>cost<span class="op">/</span>(np.power(<span class="dv">1</span><span class="op">+</span>Discount,t))</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Expected profit is expected discounted revenue minus installation cost minus discounted loan cost</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    profit<span class="op">=</span>Revenue<span class="op">-</span>((<span class="dv">1</span><span class="op">-</span>Subsidy1)<span class="op">*</span>Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>])<span class="op">-</span>LoanCost</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Get the rates of PV ownership in the income decile of each agent</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    deciles<span class="op">=</span>PVOwnershipDeciles[IncomeDeciles.astype(<span class="bu">int</span>)]</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate utility based on profit, social influence and environmental attitude</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    utility<span class="op">=</span>profit<span class="op">+</span>Influence<span class="op">*</span>(deciles<span class="op">-</span>(<span class="dv">1</span><span class="op">-</span>deciles))<span class="op">+</span>Params[<span class="st">"Beta"</span>].values[<span class="dv">0</span>]<span class="op">*</span>Attitude</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Utility for agents who are credit rationed, for whom PV is technically infeasible, or who already own PV is zero</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    utility[Rationed<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    utility[Feasible<span class="op">==</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    utility[PV<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents with positive utility adopt</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    adopters<span class="op">=</span>np.where(utility<span class="op">&gt;</span><span class="dv">0</span>)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Adopters who need a loan are borrowers</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    borrowers<span class="op">=</span>np.where((utility<span class="op">&gt;</span><span class="dv">0</span>) <span class="op">&amp;</span> (loanneeded<span class="op">&gt;</span><span class="dv">0</span>))</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    PV[adopters]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate updated liquidity, loan rates, debt and debt service payments of adopters/borrowers</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>    Liquidity[adopters]<span class="op">-=</span>((<span class="dv">1</span><span class="op">-</span>Subsidy1)<span class="op">*</span>Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>])<span class="op">+</span>loanneeded[adopters]</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    LoanRate[borrowers]<span class="op">=</span>proposedrate[borrowers]<span class="op">*</span>loanneeded[borrowers]<span class="op">/</span>(loanneeded[borrowers]<span class="op">+</span>Debt[borrowers])<span class="op">+</span>LoanRate[borrowers]<span class="op">*</span>Debt[borrowers]<span class="op">/</span>(loanneeded[borrowers]<span class="op">+</span>Debt[borrowers])</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    Debt[borrowers]<span class="op">+=</span>loanneeded[borrowers]</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    DebtService[borrowers]<span class="op">=</span>Debt[borrowers]<span class="op">*</span>(LoanRate[borrowers]<span class="op">*</span>(np.power(<span class="dv">1</span><span class="op">+</span>LoanRate[borrowers],Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>])))<span class="op">/</span>((np.power(<span class="dv">1</span><span class="op">+</span>LoanRate[borrowers],Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]))<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Return vectors of PV ownership, credit rationing, liquidity, loan rates, debt stocks and debt service payments</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[PV,Rationed,Liquidity,LoanRate,Debt,DebtService]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculate-statistics" class="level2">
<h2 class="anchored" data-anchor-id="calculate-statistics">Calculate statistics</h2>
<p>This function calculates a range of statistics, time-series of which will be returned by the main function at the end of a simulation.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> CalculateStatistics(PV,Income,Debt,Liquidity,ExpectedPrice,Feasible,Rationed):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Average income</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    averageincome<span class="op">=</span>np.<span class="bu">sum</span>(Income)<span class="op">/</span>Income.size</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Average liquidity</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    averageliquidity<span class="op">=</span>np.<span class="bu">sum</span>(Liquidity)<span class="op">/</span>Liquidity.size</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Average expected electricity price in the next period</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    averageexpectedprice<span class="op">=</span>np.<span class="bu">sum</span>(ExpectedPrice)<span class="op">/</span>ExpectedPrice.size</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Average debt, counting only agents with positive debt</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    averagedebt<span class="op">=</span>np.<span class="bu">sum</span>(Debt[Debt<span class="op">&gt;</span><span class="dv">0</span>])<span class="op">/</span>np.<span class="bu">sum</span>(Debt<span class="op">&gt;</span><span class="dv">0</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Number of PV owners as % of all agents</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    adoptionrate1<span class="op">=</span>np.<span class="bu">sum</span>(PV)<span class="op">/</span>PV.size</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Number of PV owners as % of agents for whom PV is technically feasible</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    adoptionrate2<span class="op">=</span>np.<span class="bu">sum</span>(PV)<span class="op">/</span>np.<span class="bu">sum</span>(Feasible)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Share of agents who could adopt PV but are prevented by credit rationing</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    rationing<span class="op">=</span>np.<span class="bu">sum</span>(Rationed)<span class="op">/</span>np.<span class="bu">sum</span>((PV<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (Feasible<span class="op">==</span><span class="dv">1</span>))</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(averageincome,averageliquidity,averageexpectedprice,averagedebt,adoptionrate1,adoptionrate2,rationing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="main-model-function" class="level2">
<h2 class="anchored" data-anchor-id="main-model-function">Main model function</h2>
<p>This is the function which must be called to execute the model. It takes several inputs, namely:</p>
<div class="incremental">
<ul class="incremental">
<li><code>inputfile</code> - a csv file containing a a list of all model households and their initial characteristics</li>
<li><code>propensitiesfile</code> - a csv file containing propensities to consume out of income by income percentile</li>
<li><code>liquiditysharesfile</code> - a csv file containing the shares of saving going into liquid assets by income percentile</li>
<li><code>paramfile</code> - a csv file containing the names and values of all model parameters</li>
<li><code>seed</code> - a seed for the pseudo-random number generator</li>
<li><code>start</code> - the start year of the model simulation</li>
<li><code>end</code> - the end year of the model simulation</li>
</ul>
</div>
<p>The function begins by setting the seed for the pseudo-random number generator, and then loads all necessary external input files. It then initialises the model by generating vectors/arrays of all model variables and setting initial values where necessary.</p>
<p>Subsequently, there is a single call to <code>GenerateElectricityPrice</code> in order to generate a time-series of electricity prices for the current model run. After this, the main simulation loop is entered. In each simulation period, the model calls the functions described above one after the other, updating the relevant model variables based on the outputs of each function.</p>
<p>At the end of the simulation run, the time-series of aggregate statistics to be returned are stacked into a single array and converted to a dataframe, which is then saved in csv format, with the seed number attached to the file name.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> PVModel(inputfile<span class="op">=</span><span class="st">"inputs.csv"</span>,propensitiesfile<span class="op">=</span><span class="st">"consumptionpropensities.csv"</span>,liquiditysharesfile<span class="op">=</span><span class="st">"liquidityshares.csv"</span>,paramfile<span class="op">=</span><span class="st">"parameters.csv"</span>,seed<span class="op">=</span><span class="dv">1</span>,start<span class="op">=</span><span class="dv">2018</span>,end<span class="op">=</span><span class="dv">2040</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set seed</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Load external input files</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    Inputs<span class="op">=</span>pd.read_csv(inputfile)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    Params<span class="op">=</span>pd.read_csv(paramfile)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    Propensities<span class="op">=</span>np.ndarray.flatten(pd.read_csv(propensitiesfile,header<span class="op">=</span><span class="va">None</span>).to_numpy())</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    LiquidityShares<span class="op">=</span>np.ndarray.flatten(pd.read_csv(liquiditysharesfile,header<span class="op">=</span><span class="va">None</span>).to_numpy())</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initial means of income for random draws are taken from input file</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    Income_f<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"income"</span>]].to_numpy())</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate arrays of zeros to hold actual incomes and actual incomes net of electricity cost --&gt; note that len(Inputs.index) gives the number of individual agents</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    Income<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),(end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)))</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    Income_p<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),(end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Standard deviations of incomes for random draws are taken from input file</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    Income_sd<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"incomesd"</span>]].to_numpy())</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initial means of electricity cost for random draws are taken from input file</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    Powercost_f<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"powercons"</span>]].to_numpy())</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Standard deviations of electricity cost for random draws are taken from input file</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    Powercost_sd<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"powerconssd"</span>]].to_numpy())</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate arrays of zeros to hold actual electricity cost </span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    Powercost<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),(end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)))</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate array of zeros to hold current desired consumption</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    Consumption<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate array of zeros to hold agents' liquid assets</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    Liquidity<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),(end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)))</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initial liquid assets are taken from input file</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    Liquidity[:,<span class="dv">0</span>]<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"liquidity"</span>]].to_numpy())</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate arrays of zeros to hold agents' debt, debt service and loan rates</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    Debt<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    DebtService<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    LoanRate<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Trend growth rates of mean incomes and electricity costs are taken from input file</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    Trend<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"trend"</span>]].to_numpy())</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Dummies indicating whether agents live in a house(=1) or a flat (=0) are taken from input file</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    House<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"house"</span>]].to_numpy())</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate array of zeros to hold agents' PV ownership status over time</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    PV<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),(end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)))</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initial PV ownership status is taken from input file</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    PV[:,<span class="dv">0</span>]<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"pv"</span>]].to_numpy())</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initial solar panel age is taken from input file</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    PanelAge<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"panelage"</span>]].to_numpy())</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Environmental attitude is taken from input file</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    Attitude<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"attitude"</span>]].to_numpy())</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">#The degree to which each agent is subject to social influence is given by a draw from a uniform distribution; upper and lower bounds are taken from parameter file.</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    Influence<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="bu">len</span>(Inputs.index))<span class="op">*</span>(Params[<span class="st">"MaxInfluence"</span>].values[<span class="dv">0</span>]<span class="op">-</span>Params[<span class="st">"MinInfluence"</span>].values[<span class="dv">0</span>])<span class="op">+</span>Params[<span class="st">"MinInfluence"</span>].values[<span class="dv">0</span>]</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">#The individual discount rates of agents are given by draws from a uniform distribution; upper and lower bounds are taken from parameter file.</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    Discount<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="bu">len</span>(Inputs.index))<span class="op">*</span>(Params[<span class="st">"MaxDiscount"</span>].values[<span class="dv">0</span>]<span class="op">-</span>Params[<span class="st">"MinDiscount"</span>].values[<span class="dv">0</span>])<span class="op">+</span>Params[<span class="st">"MinDiscount"</span>].values[<span class="dv">0</span>]</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate vector of zeros to hold dummies indicating whether PV is technically feasible on the dwelling of an agent</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    Feasible<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Feasibility is set to 1 for agents already owning PV</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    Feasible[PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Feasibility is set to 1 for agents living in a house</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    Feasible[House<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Feasibility is set to 1 with a certain probability for all other agents</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    Feasible[(House<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">0</span>)]<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="bu">sum</span>((House<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">0</span>)))</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>    Feasible[Feasible<span class="op">&gt;=</span>(<span class="dv">1</span><span class="op">-</span>Params[<span class="st">"FeasibilityProb"</span>].values[<span class="dv">0</span>])]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>    Feasible[Feasible<span class="op">&lt;</span>(<span class="dv">1</span><span class="op">-</span>Params[<span class="st">"FeasibilityProb"</span>].values[<span class="dv">0</span>])]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Based on the number of agents in the model, set the indices delimiting each income percentile</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>    Positions_p<span class="op">=</span>np.zeros(<span class="dv">99</span>)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    Positions_p[:]<span class="op">=</span>np.array(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">100</span>,<span class="dv">1</span>))<span class="op">*</span>(<span class="bu">len</span>(Inputs.index)<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">100</span><span class="op">-</span><span class="dv">1</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    Positions_p<span class="op">=</span>np.<span class="bu">round</span>(Positions_p)</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>    Positions_p<span class="op">=</span>Positions_p.astype(<span class="bu">int</span>)</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate a vector of zeros to hold the income cut-offs corresponding to each percentile</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>    Percentiles<span class="op">=</span>np.zeros(<span class="dv">100</span>)</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Based on the number of agents in the model, set the indices delimiting each income decile</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>    Positions_d<span class="op">=</span>np.zeros(<span class="dv">9</span>)</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>    Positions_d[:]<span class="op">=</span>np.array(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">1</span>))<span class="op">*</span>(<span class="bu">len</span>(Inputs.index)<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">10</span><span class="op">-</span><span class="dv">1</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>    Positions_d<span class="op">=</span>np.<span class="bu">round</span>(Positions_d)</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>    Positions_d<span class="op">=</span>Positions_d.astype(<span class="bu">int</span>)</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate a vector of zeros to hold the income cut-offs corresponding to each decile</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>    Deciles<span class="op">=</span>np.zeros(<span class="dv">10</span>)</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate a vector of zeros to hold the number of agents in each decile</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>    DecileMembers<span class="op">=</span>np.zeros(<span class="dv">10</span>)</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate a vector of zeros to hold the share of agents owning PV in each income decile</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>    PVOwnershipDeciles<span class="op">=</span>np.zeros(<span class="dv">10</span>)</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate vectors of zeros to hold the current income decile/percentile of each agent</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>    IncomeDeciles<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>    IncomePercentiles<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>    <span class="co">#The individual gain parameter used by each agent during expectations formation is given by a draw from a uniform distribution; upper and lower bounds are taken from parameter file.</span></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>    Gain<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="bu">len</span>(Inputs.index))<span class="op">*</span>(Params[<span class="st">"MaxGain"</span>].values[<span class="dv">0</span>]<span class="op">-</span>Params[<span class="st">"MinGain"</span>].values[<span class="dv">0</span>])<span class="op">+</span>Params[<span class="st">"MinGain"</span>].values[<span class="dv">0</span>]</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise the coefficients of agents' internal AR(1) models to those governing the true AR(1) process</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>    ARPars<span class="op">=</span>np.array([[Params[<span class="st">"ElectricityPriceTrend"</span>].values[<span class="dv">0</span>]],[Params[<span class="st">"ElectricityPriceAR"</span>].values[<span class="dv">0</span>]]])</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>    ARPars<span class="op">=</span>[ARPars]<span class="op">*</span><span class="bu">len</span>(Inputs.index)</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>    ARPars<span class="op">=</span>np.array(ARPars)</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise the variance-covariance matrices of agents' internal AR(1) models to those from the true AR(1) process</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>    ARMats<span class="op">=</span>np.array([[Params[<span class="st">"ElectricityPriceMat11"</span>].values[<span class="dv">0</span>],Params[<span class="st">"ElectricityPriceMat12"</span>].values[<span class="dv">0</span>]],[Params[<span class="st">"ElectricityPriceMat21"</span>].values[<span class="dv">0</span>],Params[<span class="st">"ElectricityPriceMat22"</span>].values[<span class="dv">0</span>]]])</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>    ARMats<span class="op">=</span>[ARMats]<span class="op">*</span><span class="bu">len</span>(Inputs.index)</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>    ARMats<span class="op">=</span>np.array(ARMats)</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate an array of zeros to hold the time-series of agents' expected electricity prices</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>    ExpectedPrice<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]))</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate arrays of zeros to hold sums of expected discounted revenue from owning PV, loan costs, and dummies indicating whether agents are credit rationed</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>    Revenue<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>    LoanCost<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>    Rationed<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise policy variables</span></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>    Subsidy1<span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>    Subsidy2<span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>    CreditPolicy1<span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>    CreditPolicy2<span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate arrays of zeros to hold aggregate statistics which will be saved after the run</span></span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>    AverageIncome<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>    AverageLiquidity<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>    AverageExpectedPrice<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>    AverageDebt<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>    AdoptionRate1<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>    AdoptionRate2<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>    ChangeAdoptionRate1<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a>    ChangeAdoptionRate2<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>    RationedShare<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate electricity price time-series for the current run</span></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>    Price<span class="op">=</span>GenerateElectricityPrice(Params<span class="op">=</span>Params,length<span class="op">=</span>(end<span class="op">-</span>start<span class="op">+</span><span class="dv">3</span>))</span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Enter main model loop</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>    year<span class="op">=</span>start</span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> period <span class="kw">in</span> <span class="bu">range</span>((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)):</span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set starting values for liquid assets and PV equal to closing values from last period</span></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> period<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>            Liquidity[:,period]<span class="op">=</span>Liquidity[:,(period<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>            PV[:,period]<span class="op">=</span>PV[:,(period<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set policy variables</span></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>        PolicyReturn<span class="op">=</span>SetPolicy(Subsidy1<span class="op">=</span>Subsidy1,Subsidy2<span class="op">=</span>Subsidy2,CreditPolicy1<span class="op">=</span>CreditPolicy1,CreditPolicy2<span class="op">=</span>CreditPolicy2,year<span class="op">=</span>year,Params<span class="op">=</span>Params)</span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>        Subsidy1<span class="op">=</span>PolicyReturn[<span class="dv">0</span>]</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>        Subsidy2<span class="op">=</span>PolicyReturn[<span class="dv">1</span>]</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>        CreditPolicy1<span class="op">=</span>PolicyReturn[<span class="dv">2</span>]</span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>        CreditPolicy2<span class="op">=</span>PolicyReturn[<span class="dv">3</span>]</span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Calculate income and electricity cost</span></span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>        IncomePowercostReturn<span class="op">=</span>IncomePowercost(Income_f<span class="op">=</span>Income_f,Trend<span class="op">=</span>Trend,Powercost_f<span class="op">=</span>Powercost_f,Income_sd<span class="op">=</span>Income_sd,Powercost_sd<span class="op">=</span>Powercost_sd,PV<span class="op">=</span>PV[:,period],Price<span class="op">=</span>Price[(period<span class="op">+</span><span class="dv">2</span>)],Subsidy2<span class="op">=</span>Subsidy2,Params<span class="op">=</span>Params)</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>        Income[:,period]<span class="op">=</span>IncomePowercostReturn[<span class="dv">0</span>]</span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>        Powercost[:,period]<span class="op">=</span>IncomePowercostReturn[<span class="dv">1</span>]</span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>        Income_p[:,period]<span class="op">=</span>IncomePowercostReturn[<span class="dv">2</span>]</span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Calculate income distribution statistics and PV ownership by decile</span></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>        IncomeGroupReturn<span class="op">=</span>IncomeGroups(Income_p<span class="op">=</span>Income_p[:,period],PV<span class="op">=</span>PV[:,period],Positions_p<span class="op">=</span>Positions_p,Percentiles<span class="op">=</span>Percentiles,Positions_d<span class="op">=</span>Positions_d,Deciles<span class="op">=</span>Deciles,IncomePercentiles<span class="op">=</span>IncomePercentiles,IncomeDeciles<span class="op">=</span>IncomeDeciles,PVOwnershipDeciles<span class="op">=</span>PVOwnershipDeciles,DecileMembers<span class="op">=</span>DecileMembers)</span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>        IncomePercentiles[:]<span class="op">=</span>IncomeGroupReturn[<span class="dv">0</span>]</span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>        IncomeDeciles[:]<span class="op">=</span>IncomeGroupReturn[<span class="dv">1</span>]</span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>        PVOwnershipDeciles[:]<span class="op">=</span>IncomeGroupReturn[<span class="dv">2</span>]</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Calculate consumption, saving and debt service; update liquidity</span></span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>        ConsumptionSavingReturn<span class="op">=</span>ConsumptionSaving(Income_p<span class="op">=</span>Income_p[:,period],Propensities<span class="op">=</span>Propensities,IncomePercentiles<span class="op">=</span>IncomePercentiles,Consumption<span class="op">=</span>Consumption,Income<span class="op">=</span>Income[:,period],Powercost<span class="op">=</span>Powercost[:,period],Liquidity<span class="op">=</span>Liquidity[:,period],Debt<span class="op">=</span>Debt,DebtService<span class="op">=</span>DebtService,LoanRate<span class="op">=</span>LoanRate,PanelAge<span class="op">=</span>PanelAge,LiquidityShares<span class="op">=</span>LiquidityShares,Params<span class="op">=</span>Params,period<span class="op">=</span>period)</span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>        Liquidity[:,period]<span class="op">=</span>ConsumptionSavingReturn[<span class="dv">0</span>]</span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>        Debt[:]<span class="op">=</span>ConsumptionSavingReturn[<span class="dv">1</span>]</span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>        DebtService[:]<span class="op">=</span>ConsumptionSavingReturn[<span class="dv">2</span>]</span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>        LoanRate[:]<span class="op">=</span>ConsumptionSavingReturn[<span class="dv">3</span>]</span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>        Consumption[:]<span class="op">=</span>ConsumptionSavingReturn[<span class="dv">4</span>]</span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Increment age of existing panels; reset PV ownership if a panel reaches maximum age</span></span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>        PanelAgeReturn<span class="op">=</span>AugmentPanelAge(PV<span class="op">=</span>PV[:,period],PanelAge<span class="op">=</span>PanelAge,Params<span class="op">=</span>Params)</span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>        PanelAge<span class="op">=</span>PanelAgeReturn[<span class="dv">0</span>]</span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a>        PV[:,period]<span class="op">=</span>PanelAgeReturn[<span class="dv">1</span>]</span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Form expectations of future electricity price</span></span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>        ExpectationReturn<span class="op">=</span>FormExpectation(ARPars<span class="op">=</span>ARPars,ARMats<span class="op">=</span>ARMats,Price<span class="op">=</span>Price,Gain<span class="op">=</span>Gain,ExpectedPrice<span class="op">=</span>ExpectedPrice,period<span class="op">=</span>period)</span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>        ARMats<span class="op">=</span>ExpectationReturn[<span class="dv">0</span>]</span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a>        ARPars<span class="op">=</span>ExpectationReturn[<span class="dv">1</span>]</span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a>        ExpectedPrice<span class="op">=</span>ExpectationReturn[<span class="dv">2</span>]</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Adoption decision; update liquidity, debt, PV ownership etc.</span></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a>        AdoptionReturn<span class="op">=</span>AdoptionDecision(PV<span class="op">=</span>PV[:,period],Feasible<span class="op">=</span>Feasible,Liquidity<span class="op">=</span>Liquidity[:,period],Rationed<span class="op">=</span>Rationed,Debt<span class="op">=</span>Debt,Income<span class="op">=</span>Income[:,period],ExpectedPrice<span class="op">=</span>ExpectedPrice,Discount<span class="op">=</span>Discount,Revenue<span class="op">=</span>Revenue,LoanCost<span class="op">=</span>LoanCost,PVOwnershipDeciles<span class="op">=</span>PVOwnershipDeciles,IncomeDeciles<span class="op">=</span>IncomeDeciles,LoanRate<span class="op">=</span>LoanRate,DebtService<span class="op">=</span>DebtService,Influence<span class="op">=</span>Influence,Attitude<span class="op">=</span>Attitude,Subsidy1<span class="op">=</span>Subsidy1,Subsidy2<span class="op">=</span>Subsidy2,CreditPolicy1<span class="op">=</span>CreditPolicy1,CreditPolicy2<span class="op">=</span>CreditPolicy2,Params<span class="op">=</span>Params)</span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a>        PV[:,period]<span class="op">=</span>AdoptionReturn[<span class="dv">0</span>]</span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a>        Rationed[:]<span class="op">=</span>AdoptionReturn[<span class="dv">1</span>]</span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a>        Liquidity[:,period]<span class="op">=</span>AdoptionReturn[<span class="dv">2</span>]</span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a>        LoanRate[:]<span class="op">=</span>AdoptionReturn[<span class="dv">3</span>]</span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>        Debt[:]<span class="op">=</span>AdoptionReturn[<span class="dv">4</span>]</span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>        DebtService[:]<span class="op">=</span>AdoptionReturn[<span class="dv">5</span>]</span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Calculate aggregate statistics</span></span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>        StatisticsReturn<span class="op">=</span>CalculateStatistics(PV<span class="op">=</span>PV[:,period],Income<span class="op">=</span>Income[:,period],Debt<span class="op">=</span>Debt,Liquidity<span class="op">=</span>Liquidity[:,period],ExpectedPrice<span class="op">=</span>ExpectedPrice[:,<span class="dv">0</span>],Feasible<span class="op">=</span>Feasible,Rationed<span class="op">=</span>Rationed)</span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a>        AverageIncome[period]<span class="op">=</span>StatisticsReturn[<span class="dv">0</span>]</span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>        AverageLiquidity[period]<span class="op">=</span>StatisticsReturn[<span class="dv">1</span>]</span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a>        AverageExpectedPrice[period]<span class="op">=</span>StatisticsReturn[<span class="dv">2</span>]</span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>        AverageDebt[period]<span class="op">=</span>StatisticsReturn[<span class="dv">3</span>]</span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a>        AdoptionRate1[period]<span class="op">=</span>StatisticsReturn[<span class="dv">4</span>]</span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a>        AdoptionRate2[period]<span class="op">=</span>StatisticsReturn[<span class="dv">5</span>]</span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a>        RationedShare[period]<span class="op">=</span>StatisticsReturn[<span class="dv">6</span>]</span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> period<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>            ChangeAdoptionRate1[period]<span class="op">=</span>AdoptionRate1[period]<span class="op">-</span>AdoptionRate1[(period<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>            ChangeAdoptionRate2[period]<span class="op">=</span>AdoptionRate2[period]<span class="op">-</span>AdoptionRate2[(period<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Increment year</span></span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a>        year<span class="op">+=</span><span class="dv">1</span></span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Save time-series of aggregate statistics as csv</span></span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a>    Stats<span class="op">=</span>np.column_stack((AverageIncome,AverageLiquidity,AverageExpectedPrice,AverageDebt,AdoptionRate1,AdoptionRate2,ChangeAdoptionRate1,ChangeAdoptionRate2,RationedShare,Price[<span class="dv">2</span>:<span class="bu">len</span>(Price)]))</span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a>    Stats<span class="op">=</span>pd.DataFrame(data<span class="op">=</span>Stats,columns<span class="op">=</span>[<span class="st">"AverageIncome"</span>,<span class="st">"AverageLiquidity"</span>,<span class="st">"AverageExpectedPrice"</span>,<span class="st">"AverageDebt"</span>,<span class="st">"AdoptionRate1"</span>,<span class="st">"AdoptionRate2"</span>,<span class="st">"ChangeAdoptionRate1"</span>,<span class="st">"ChangeAdoptionRate2"</span>,<span class="st">"RationedShare"</span>,<span class="st">"Price"</span>])</span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a>    filename<span class="op">=</span><span class="st">'out_'</span></span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a>    filename<span class="op">+=</span><span class="bu">str</span>(seed)</span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a>    filename<span class="op">+=</span><span class="st">'.csv'</span></span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>    Stats.to_csv(filename)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>
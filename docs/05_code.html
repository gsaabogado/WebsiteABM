<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.237">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Severin Reissl and Luis Sarmiento">

<title>The Agent-Based Model of Technology Adoption (ABM-REN) - Model Code</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">The Agent-Based Model of Technology Adoption (ABM-REN)</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./01_about.html" aria-current="page">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/gsaabogado"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/gsaabogado"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://luissarmiento.net/">
 <span class="menu-text">Personal Site</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Model Code</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">Sections</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_about.html" class="sidebar-item-text sidebar-link">About</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_data.html" class="sidebar-item-text sidebar-link">Data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_model.html" class="sidebar-item-text sidebar-link">Model Overview</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_code.html" class="sidebar-item-text sidebar-link active">Model Code</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_modelresults.html" class="sidebar-item-text sidebar-link">Model Results</a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#generate-electricity-price" id="toc-generate-electricity-price" class="nav-link active" data-scroll-target="#generate-electricity-price">Generate Electricity Price</a></li>
  <li><a href="#set-policy" id="toc-set-policy" class="nav-link" data-scroll-target="#set-policy">Set Policy</a></li>
  <li><a href="#income-and-power-cost" id="toc-income-and-power-cost" class="nav-link" data-scroll-target="#income-and-power-cost">Income and Power cost</a></li>
  <li><a href="#income-groups" id="toc-income-groups" class="nav-link" data-scroll-target="#income-groups">Income Groups</a></li>
  <li><a href="#consumption-and-saving" id="toc-consumption-and-saving" class="nav-link" data-scroll-target="#consumption-and-saving">Consumption and saving</a></li>
  <li><a href="#augment-panel-age" id="toc-augment-panel-age" class="nav-link" data-scroll-target="#augment-panel-age">Augment panel age</a></li>
  <li><a href="#expectations-formation" id="toc-expectations-formation" class="nav-link" data-scroll-target="#expectations-formation">Expectations formation</a></li>
  <li><a href="#adoption-decision" id="toc-adoption-decision" class="nav-link" data-scroll-target="#adoption-decision">Adoption Decision</a></li>
  <li><a href="#pv-deciles" id="toc-pv-deciles" class="nav-link" data-scroll-target="#pv-deciles">PV Deciles</a></li>
  <li><a href="#calculate-statistics" id="toc-calculate-statistics" class="nav-link" data-scroll-target="#calculate-statistics">Calculate statistics</a></li>
  <li><a href="#main-model-function" id="toc-main-model-function" class="nav-link" data-scroll-target="#main-model-function">Main model function</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Model Code</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Severin Reissl and Luis Sarmiento </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<p>The model is written in Python. Below we provide a step-by-step documentation of all model functions. In total the model consists of 10 separate functions, which are in turn called by one main model function containing the initialisation and the main simulation loop. This main function is described last.</p>
<section id="generate-electricity-price" class="level2">
<h2 class="anchored" data-anchor-id="generate-electricity-price">Generate Electricity Price</h2>
<p>This function is called once at the beginning of a simulation run in order to generate a time-series of the electricity price which agents have to pay at each time-step of the simulation (note that this is different from the expected future electricity price, described below).</p>
<p>The function takes four inputs. <code>_PriceEmp</code> is a pandas dataframe containing an empirical time-series of the electricity price. <code>_Params</code>, is a pandas dataframe containing the names and values of the model parameters. <code>_length</code>, is an integer denoting the length of the time-series to be created (given by simulation length+2 since we need two lagged values at the beginning for the expectations formation process discussed below). Finally, <code>_start</code> denotes the start year of the simulation</p>
<p>The function then creates two numpy vectors of zeros of size <code>_length</code>. <code>electricityprice1</code> is the vector of prices that will actually be used in the simulation. <code>electricityprice2</code> instead is a vector of prices which will be used to train the agents’ expectations formation mechanism prior to the beginning of the simulation.</p>
<p>The first two elements of the vectors are set to the empirical values of the electricity price in <code>_start-2</code> and <code>_start-1</code>. The rest of the vector <code>electricityprice1</code> is then filled either with empirical values of the price (if these are available, e.g.&nbsp;because we are simulating past years rather than the future) or by iterating forward an AR(1) model previously estimated on the empirical price data, including a normally distributed random shock the standard deviation of which is taken from the standard deviation of the residuals from the estimation of the AR(1) model. <code>electricityprice2</code>, the “training set”, is filled completely with simulated values from the AR(1) model. Finally, the function returns the two time-series of the electricity price.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> GenerateElectricityPrice(_PriceEmp,_Params,_length,_start):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vectors of zeros</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    electricityprice1<span class="op">=</span>np.zeros(_length)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    electricityprice2<span class="op">=</span>np.zeros(_length)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set first two elements to empirical electricity price in _start-2 and _start-1</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    electricityprice1[<span class="dv">0</span>]<span class="op">=</span>_PriceEmp[<span class="bu">str</span>(_start<span class="op">-</span><span class="dv">2</span>)].values[<span class="dv">0</span>]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    electricityprice2[<span class="dv">0</span>]<span class="op">=</span>_PriceEmp[<span class="bu">str</span>(_start<span class="op">-</span><span class="dv">2</span>)].values[<span class="dv">0</span>]</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    electricityprice1[<span class="dv">1</span>]<span class="op">=</span>_PriceEmp[<span class="bu">str</span>(_start<span class="op">-</span><span class="dv">1</span>)].values[<span class="dv">0</span>]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    electricityprice2[<span class="dv">1</span>]<span class="op">=</span>_PriceEmp[<span class="bu">str</span>(_start<span class="op">-</span><span class="dv">1</span>)].values[<span class="dv">0</span>]</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Iterate over rest of vector</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>,_length):</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">#If the empirical price-series still contains values, use them to fill electricityprice1</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">sum</span>(<span class="bu">str</span>(_start<span class="op">-</span><span class="dv">2</span><span class="op">+</span>t)<span class="op">==</span>_PriceEmp.columns)<span class="op">==</span><span class="dv">1</span>:</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>            electricityprice1[t]<span class="op">=</span>_PriceEmp[<span class="bu">str</span>(_start<span class="op">-</span><span class="dv">2</span><span class="op">+</span>t)].values[<span class="dv">0</span>]</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Otherwise, fill the rest of electricityprice1 with simulated prices using a previously estimated AR1 model</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">#Generate normally distributed shock based on standard deviation of regression residuals</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>            shock1<span class="op">=</span>_Params[<span class="st">"ElectricityPriceSD"</span>].values[<span class="dv">0</span>]<span class="op">*</span>np.sqrt(<span class="op">-</span><span class="dv">2</span><span class="op">*</span>np.log(np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>)))<span class="op">*</span>np.cos(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>            <span class="co">#Price in t calculated by iterating AR(1) model</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>            electricityprice1[t]<span class="op">=</span>electricityprice1[t<span class="op">-</span><span class="dv">1</span>]<span class="op">+</span>_Params[<span class="st">"ElectricityPriceTrend"</span>].values[<span class="dv">0</span>]<span class="op">+</span>_Params[<span class="st">"ElectricityPriceAR"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(electricityprice1[t<span class="op">-</span><span class="dv">1</span>]<span class="op">-</span>electricityprice1[t<span class="op">-</span><span class="dv">2</span>])<span class="op">+</span>shock1 </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">#electricityprice2, which is used to train the expectations formation mechanism, is filled completely with simulated values</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Generate normally distributed shock based on standard deviation of regression residuals</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        shock2<span class="op">=</span>_Params[<span class="st">"ElectricityPriceSD"</span>].values[<span class="dv">0</span>]<span class="op">*</span>np.sqrt(<span class="op">-</span><span class="dv">2</span><span class="op">*</span>np.log(np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>)))<span class="op">*</span>np.cos(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Price in t calculated by iterating AR(1) model</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        electricityprice2[t]<span class="op">=</span>electricityprice2[t<span class="op">-</span><span class="dv">1</span>]<span class="op">+</span>_Params[<span class="st">"ElectricityPriceTrend"</span>].values[<span class="dv">0</span>]<span class="op">+</span>_Params[<span class="st">"ElectricityPriceAR"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(electricityprice2[t<span class="op">-</span><span class="dv">1</span>]<span class="op">-</span>electricityprice2[t<span class="op">-</span><span class="dv">2</span>])<span class="op">+</span>shock2</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [electricityprice1,electricityprice2]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-policy" class="level2">
<h2 class="anchored" data-anchor-id="set-policy">Set Policy</h2>
<p>Depending on the values of various dummies in the <code>_Params</code> dataframe and the current simulation period <code>_year</code>, this function determines whether a policy experiment should be activated in the current period.</p>
<p>At present, the model includes four possible policies, namely a subsidy on the cost of a solar panel (<code>Subsidy1</code>), a subsidy on the price at which electricity generated by PV can be sold to the grid (<code>Subsidy2</code>), a policy increasing the maximum permitted loan to value ratio for bank loans to acquire PV (<code>CreditPolicy1</code>, currently not used since in the baseline the maximum LTV is already set to 1), and a policy increasing the maximum allowed debt service to income ratio resulting from a loan made to acquire PV (<code>CreditPolicy2</code>). For instance, if the dummy <code>_Subsidy1</code> is set to 1 and if the current simulation period (expressed as a year) is equal to or larger than <code>SubsidyStart</code>, a subsidy on the installation cost of PV will be activated. The function checks the conditions for the respective policy variables in each period, changes them if necessary, and then returns them.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> SetPolicy(_Subsidy1,_Subsidy2,_CreditPolicy1,_CreditPolicy2,_year,_Params):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _Params[<span class="st">"Subsidy1"</span>].values[<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span> _year<span class="op">&gt;=</span>_Params[<span class="st">"SubsidyStart"</span>].values[<span class="dv">0</span>]:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        _Subsidy1<span class="op">=</span>_Params[<span class="st">"s1"</span>].values[<span class="dv">0</span>]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _Params[<span class="st">"Subsidy2"</span>].values[<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span> _year<span class="op">&gt;=</span>_Params[<span class="st">"SubsidyStart"</span>].values[<span class="dv">0</span>]:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        _Subsidy2<span class="op">=</span>_Params[<span class="st">"s2"</span>].values[<span class="dv">0</span>]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _Params[<span class="st">"CreditPolicy1"</span>].values[<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span> _year<span class="op">&gt;=</span>_Params[<span class="st">"CreditPolicyStart"</span>].values[<span class="dv">0</span>]:</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        _CreditPolicy1<span class="op">=</span>_Params[<span class="st">"cp1"</span>].values[<span class="dv">0</span>]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _Params[<span class="st">"CreditPolicy2"</span>].values[<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span> <span class="op">&amp;</span> _year<span class="op">&gt;=</span>_Params[<span class="st">"CreditPolicyStart"</span>].values[<span class="dv">0</span>]:</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        _CreditPolicy2<span class="op">=</span>_Params[<span class="st">"cp2"</span>].values[<span class="dv">0</span>]</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[_Subsidy1,_Subsidy2,_CreditPolicy1,_CreditPolicy2]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="income-and-power-cost" class="level2">
<h2 class="anchored" data-anchor-id="income-and-power-cost">Income and Power cost</h2>
<p>This function generates the incomes and electricity costs for each agent in every period. <code>_Income_f</code> and <code>_Powercost_f</code> are vectors of length <em>N</em>, where <em>N</em> is the number of agents in the model. The deterministic values of income and power cost for each agent are assumed to grow at rate <code>_Trend</code> (which may be heterogeneous across agents but is currently uniform) at each time step. The electricity cost to be paid by each agent is deterministic, while their income in the current period is drawn from a normal distribution with mean <code>_Income_f</code> and standard deviation <code>_Income_sd</code>.</p>
<p>Having determined income and power cost for each agent, we move on to calculate the revenue/cost saving generated by solar panels in the current period. We begin by setting <code>panelrevenue</code> as a copy of <code>_PV</code>, a vector of dummies indicating whether an agent owns PV in the current period. Hence <code>panelrevenue</code> is zero (and will remain zero in the calculations below) for agents who do not own PV.</p>
<p>We then calculate <code>panelrevenue</code> for the agents who do own PV, by dividing them into 4 groups depending on whether their own electricity consumption in the current period is larger or smaller than the capacity of the solar panel and whether their feed-in tariff (FIT; possibly including an additional subsidy if one is in force, see the function above) is higher or lower than the current electricity price (note that, as in reality in Germany, the feed-in tariff depends on the year in which the PV was installed and remains constant thereafter, meaning that agents will receive different FITs depending on how old their panel is). <code>panelrevenue</code> is then set for each of the four groups, assuming that agents can consume a maximum of <code>_Params["PVCons"].values[0]</code> of the amount of electricity generated by the panel.</p>
<p>The electricity cost of agents owning PV is then reduced by <code>panelrevenue</code> (note that this can lead to cases in which electricity cost becomes smaller than 0 when the revenue from the panel exceeds electricity cost). In addition, <code>_CumulativeProfit</code>, which keeps track of the profit which PV owners have derived from their panel over its lifetime, is updated. Finally, we calculate a measure of income net of electricity cost which is used below to calculate income distribution statistics.</p>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> IncomePowercost(_Income_f,_Trend,_Powercost_f,_Income_sd,_CumulativeProfit,_PV,_Price,_PanelFIT,_Subsidy2,_Params):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Deterministic income and power cost values grow at exogenous trend</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    _Income_f<span class="op">=</span>_Income_f<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>_Trend)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    _Powercost_f<span class="op">=</span>_Powercost_f<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>_Trend)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Actual income is drawn from a normal distribution with mean _Income_f and standard deviation _Income_sd</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    randincome<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,_Income_f.size)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    randincome2<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,_Income_f.size)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    randincome<span class="op">=</span>np.sqrt(<span class="op">-</span><span class="dv">2</span><span class="op">*</span>np.log(randincome))<span class="op">*</span>np.cos(<span class="dv">2</span><span class="op">*</span>np.pi<span class="op">*</span>randincome2)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    randincome<span class="op">=</span>_Income_sd<span class="op">*</span>randincome<span class="op">*</span>_Income_f<span class="op">+</span>_Income_f</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    randincome<span class="op">=</span>np.maximum(<span class="fl">1e-10</span>,randincome)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Power cost is multiplied by current electricity price</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    powercost<span class="op">=</span>_Powercost_f<span class="op">*</span>_Price</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate revenue/cost saving generated by existing solar panels in the current period. Note that if _PV=0, panelrevenue=0</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    panelrevenue<span class="op">=</span>_PV.copy()</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who own PV, whose electricity consumption exceeds the capacity of the panel and whose FIT is smaller than the current electricity price</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    group1<span class="op">=</span>np.where((_PV<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (_Powercost_f<span class="op">&gt;=</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]) <span class="op">&amp;</span> ((_PanelFIT<span class="op">+</span>_Subsidy2)<span class="op">&lt;</span>_Price))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who own PV, whose electricity consumption exceeds the capacity of the panel and whose FIT is larger than the current electricity price</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    group2<span class="op">=</span>np.where((_PV<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (_Powercost_f<span class="op">&gt;=</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]) <span class="op">&amp;</span> ((_PanelFIT<span class="op">+</span>_Subsidy2)<span class="op">&gt;=</span>_Price))</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who own PV, whose electricity consumption is smaller than the capacity of the panel and whose FIT is smaller than the current electricity price</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    group3<span class="op">=</span>np.where((_PV<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (_Powercost_f<span class="op">&lt;</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]) <span class="op">&amp;</span> ((_PanelFIT<span class="op">+</span>_Subsidy2)<span class="op">&lt;</span>_Price))</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who own PV, whose electricity consumption is smaller than the capacity of the panel and whose FIT is larger than the current electricity price</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    group4<span class="op">=</span>np.where((_PV<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (_Powercost_f<span class="op">&lt;</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]) <span class="op">&amp;</span> ((_PanelFIT<span class="op">+</span>_Subsidy2)<span class="op">&gt;=</span>_Price))</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Revenue of group 1 is given by share of own consumption times capacity times price plus electricity fed into the grid times FIT</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    panelrevenue[group1]<span class="op">=</span>_Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>]<span class="op">*</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">*</span>_Price<span class="op">+</span>(<span class="dv">1</span><span class="op">-</span>_Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>])<span class="op">*</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(_PanelFIT[group1]<span class="op">+</span>_Subsidy2)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Revenue of group 2 is given by capacity times FIT</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    panelrevenue[group2]<span class="op">=</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(_PanelFIT[group2]<span class="op">+</span>_Subsidy2)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Revenue of group 3 is given by minimum between own consumption share times capacity times price and electricity consumption times price, plus the remaining capacity of the panel times FIT</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    panelrevenue[group3]<span class="op">=</span>np.minimum(_Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>]<span class="op">*</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>],_Powercost_f[group3])<span class="op">*</span>_Price<span class="op">+</span>(_PanelFIT[group3]<span class="op">+</span>_Subsidy2)<span class="op">*</span>(_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">-</span>np.minimum(_Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>]<span class="op">*</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>],_Powercost_f[group3]))</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Revenue of group 4 is given by capacity times FIT</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    panelrevenue[group4]<span class="op">=</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(_PanelFIT[group4]<span class="op">+</span>_Subsidy2)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Reduce electricity cost by the revenue/cost saving generated by solar panels</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    powercost<span class="op">=</span>powercost<span class="op">-</span>panelrevenue</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update cumulative profit of PV owners</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    _CumulativeProfit[_PV<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span>_CumulativeProfit[_PV<span class="op">==</span><span class="dv">1</span>]<span class="op">+</span>panelrevenue[_PV<span class="op">==</span><span class="dv">1</span>]</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate income net of power cost</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    income_p<span class="op">=</span>randincome<span class="op">-</span>powercost</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    income_p<span class="op">=</span>np.maximum(<span class="dv">0</span>,income_p)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[randincome,powercost,income_p,_CumulativeProfit,_Income_f,_Powercost_f]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="income-groups" class="level2">
<h2 class="anchored" data-anchor-id="income-groups">Income Groups</h2>
<p>The purpose of this function is to calculate income distribution statistics, as well as the rates of PV ownership by income decile, which are used in other parts of the model. We begin by sorting <code>_Income_p</code>, the vector containing income net of electricity cost, in ascending order. Next, we set the cut-off points for income deciles and percentiles using the vectors <code>_Positions_p</code> and <code>_Positions_d</code>, which are calculated during the initialisation phase (described below) based on the number of agents in the model and give the number of agents in each decile/percentile. Next we iterate over all deciles and percentiles, assinging to each agent their income decile/percentile based on their current income net of electricity cost.</p>
<p>The function returns <code>_IncomePercentiles</code> and <code>_IncomeDeciles</code>, two vectors of length <em>N</em>, in which each element gives the income percentile/decile of the respective agent.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> IncomeGroups(_Income_p,_Positions_p,_Percentiles,_Positions_d,_Deciles,_IncomePercentiles,_IncomeDeciles):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Sort income net of electricity cost in ascending order</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    income_psorted<span class="op">=</span>np.sort(_Income_p)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Based on sorted income and number of agents in each decile/percentile, set cut-off points</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    _Percentiles[<span class="dv">0</span>:<span class="dv">99</span>]<span class="op">=</span>income_psorted[_Positions_p]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    _Percentiles[<span class="dv">99</span>]<span class="op">=</span>income_psorted[((income_psorted.size)<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    _Deciles[<span class="dv">0</span>:<span class="dv">9</span>]<span class="op">=</span>income_psorted[_Positions_d]</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    _Deciles[<span class="dv">9</span>]<span class="op">=</span>income_psorted[((income_psorted.size)<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Iterate over deciles</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Determine which agents belong to decile i</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>            members<span class="op">=</span>np.where(_Income_p<span class="op">&lt;=</span>_Deciles[i])</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            members<span class="op">=</span>np.where((_Income_p<span class="op">&lt;=</span>_Deciles[i]) <span class="op">&amp;</span> (_Income_p<span class="op">&gt;</span>_Deciles[(i<span class="op">-</span><span class="dv">1</span>)]))</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set decile of all members to i</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        _IncomeDeciles[members]<span class="op">=</span>i</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Iterate over percentiles</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Determine which agents belong to percentile i</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>            members<span class="op">=</span>np.where(_Income_p<span class="op">&lt;=</span>_Percentiles[i])</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>            members<span class="op">=</span>np.where((_Income_p<span class="op">&lt;=</span>_Percentiles[i]) <span class="op">&amp;</span> (_Income_p<span class="op">&gt;</span>_Percentiles[(i<span class="op">-</span><span class="dv">1</span>)]))</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set percentile of all members to i</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        _IncomePercentiles[members]<span class="op">=</span>i</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[_IncomePercentiles,_IncomeDeciles]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="consumption-and-saving" class="level2">
<h2 class="anchored" data-anchor-id="consumption-and-saving">Consumption and saving</h2>
<p>This function determines agents’ consumption and saving. In addition, agents with positive outstanding debt make debt service payments. The main purpose of this is to update agents’ <code>_Liquidity</code> , i.e.&nbsp;their stock of liquid assets (money) which can be used to buy PV.</p>
<p>The function begins by setting a consumption propensity out of income net of electricity cost for each agent based on their current income percentile. From this, their desired consumption is determined, including a persistence component. Income, electricity cost and desired consumption are then used to calculate the desired saving of each agent. If an agent cannot finance their desired consumption and electricity cost using current income and accumulated liquid assets, their actual consumption is implicitly curtailed such that their liquidity does not become negative (since we assume that households cannot borrow for consumption but only to acquire PV).</p>
<p>Next, agents with positive debt make debt service payments, which are divided into principal payments (which reduce the stock of outstanding debt) and interest payments. Any interest payments which agents cannot afford are added to their balance of outstanding debt and their debt service payments for the following periods are updated accordingly. Agents whose debt has become zero in the current period (i.e.&nbsp;they have paid off their full loan) have their interest rate and debt service payments set to zero. <code>_CumulativeProfit</code>, which keeps track of the profit/cost saving which PV owners have derived from their solar panel is updated using interest payments made.</p>
<p>Finally, if an agent has positive saving after debt service in the current period, their liquidity is updated by a fraction of that increment. This fraction is based on the agent’s current income decile and reflects the share of financial wealth held as liquid assets by income group.</p>
<p>The function returns agents’ updated current liquidity, debt, debt service payments, loan interest rates and <em>desired</em> consumption (the latter is used in the next period to calculate the persistence component of desired consumption).</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ConsumptionSaving(_Income_p,_Propensities,_IncomePercentiles,_Consumption,_Income,_Powercost,_Liquidity,_Debt,_DebtService,_LoanRate,_PanelAge,_CumulativeProfit,_LiquidityShares,_Params,_period):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Determine agents' consumption propensities out of income net of electricity cost based on their current income percentile</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    consshares<span class="op">=</span>_Propensities[_IncomePercentiles.astype(<span class="bu">int</span>)]</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Determine desired consumption</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _period<span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        _Consumption[:]<span class="op">=</span>consshares<span class="op">*</span>_Income_p</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">#If simulation period&gt;0, take into account persistence in desired consumption</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        _Consumption[:]<span class="op">=</span>_Params[<span class="st">"PersistenceConsumption"</span>].values[<span class="dv">0</span>]<span class="op">*</span>_Consumption[:]<span class="op">+</span>(<span class="dv">1</span><span class="op">-</span>_Params[<span class="st">"PersistenceConsumption"</span>].values[<span class="dv">0</span>])<span class="op">*</span>consshares<span class="op">*</span>_Income_p</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents' desired saving is gross income minus (desired) consumption minus electricity cost</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    saving<span class="op">=</span>_Income<span class="op">-</span>_Consumption<span class="op">-</span>_Powercost</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Save pre-consumption liquidity (stock of money) of each agent</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    Liquidity_p<span class="op">=</span>_Liquidity.copy()</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#If liquidity and income are greater than consumption plus electricity cost, update liquidity using saving (which may be negative!)</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    _Liquidity[(Liquidity_p<span class="op">+</span>_Income)<span class="op">&gt;=</span>(_Consumption<span class="op">+</span>_Powercost)]<span class="op">=</span>_Liquidity[(Liquidity_p<span class="op">+</span>_Income)<span class="op">&gt;=</span>(_Consumption<span class="op">+</span>_Powercost)]<span class="op">+</span>saving[(Liquidity_p<span class="op">+</span>_Income)<span class="op">&gt;=</span>(_Consumption<span class="op">+</span>_Powercost)]</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Otherwise, liquidity is set to 0; consumption is implicitly reduced to ensure liquidity does not become negative</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    _Liquidity[(Liquidity_p<span class="op">+</span>_Income)<span class="op">&lt;</span>(_Consumption<span class="op">+</span>_Powercost)]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Determine debt service for agents with positive debt</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    _DebtService[_Debt<span class="op">&gt;</span><span class="dv">0</span>]<span class="op">=</span>np.minimum(_DebtService[_Debt<span class="op">&gt;</span><span class="dv">0</span>],_Debt[_Debt<span class="op">&gt;</span><span class="dv">0</span>])</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Decompose debt service into interest and principal component</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    interest<span class="op">=</span>_LoanRate<span class="op">*</span>_Debt</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    principal<span class="op">=</span>_DebtService<span class="op">-</span>interest</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update remaining term of loan</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    term<span class="op">=</span>np.maximum(<span class="dv">1</span>,_Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]<span class="op">-</span>_PanelAge)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Principal is paid if agent can afford to do so; debt is reduced</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    _Debt[_Liquidity<span class="op">&gt;=</span>_DebtService]<span class="op">=</span>_Debt[_Liquidity<span class="op">&gt;=</span>_DebtService]<span class="op">-</span>principal[_Liquidity<span class="op">&gt;=</span>_DebtService]</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who cannot afford full principal pay as much as they can</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    _Debt[(_Liquidity<span class="op">&gt;=</span>interest) <span class="op">&amp;</span> (_Liquidity<span class="op">&lt;</span>_DebtService)]<span class="op">=</span>_Debt[(_Liquidity<span class="op">&gt;=</span>interest) <span class="op">&amp;</span> (_Liquidity<span class="op">&lt;</span>_DebtService)]<span class="op">-</span>_Liquidity[(_Liquidity<span class="op">&gt;=</span>interest) <span class="op">&amp;</span> (_Liquidity<span class="op">&lt;</span>_DebtService)]</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Any unpaid interest is added to outstanding debt</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    _Debt[_Liquidity<span class="op">&lt;</span>interest]<span class="op">=</span>_Debt[_Liquidity<span class="op">&lt;</span>interest]<span class="op">+</span>interest[_Liquidity<span class="op">&lt;</span>interest]<span class="op">-</span>_Liquidity[_Liquidity<span class="op">&lt;</span>interest]</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update cumulative profit of PV owners by interested paid on loans to acquire PV</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    interest[_Liquidity<span class="op">&lt;</span>interest]<span class="op">=</span>interest[_Liquidity<span class="op">&lt;</span>interest]<span class="op">-</span>_Liquidity[_Liquidity<span class="op">&lt;</span>interest]</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    _CumulativeProfit<span class="op">=</span>_CumulativeProfit<span class="op">-</span>interest</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Find agents who did not fully service debt</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    adjustservice<span class="op">=</span>np.where(_Liquidity<span class="op">&lt;</span>_DebtService)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>     <span class="co">#Update liquidity based on debt service made</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    Liquidity_pd<span class="op">=</span>_Liquidity.copy()</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    _Liquidity[Liquidity_pd<span class="op">&lt;</span>_DebtService]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    _Liquidity[Liquidity_pd<span class="op">&gt;=</span>_DebtService]<span class="op">=</span>_Liquidity[Liquidity_pd<span class="op">&gt;=</span>_DebtService]<span class="op">-</span>_DebtService[Liquidity_pd<span class="op">&gt;=</span>_DebtService]</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Adjust debt service of agents who did not pay full debt service</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    _DebtService[adjustservice]<span class="op">=</span>_Debt[adjustservice]<span class="op">*</span>(_LoanRate[adjustservice]<span class="op">*</span>np.power((<span class="dv">1</span><span class="op">+</span>_LoanRate[adjustservice]),term[adjustservice]))<span class="op">/</span>(np.power((<span class="dv">1</span><span class="op">+</span>_LoanRate[adjustservice]),term[adjustservice])<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>     <span class="co">#Set loan rate, debt service and debt of agents who have paid off their loans to 0 (&lt;=0) is used here since rounding errors can lead to slightly negative debt</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    _LoanRate[_Debt<span class="op">&lt;=</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    _DebtService[_Debt<span class="op">&lt;=</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    _Debt[_Debt<span class="op">&lt;=</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update liquidity based on shares of savings going into liquid assets by income percentile</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    shares<span class="op">=</span>_LiquidityShares[_IncomePercentiles.astype(<span class="bu">int</span>)]</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    _Liquidity[_Liquidity<span class="op">&gt;</span>Liquidity_p]<span class="op">=</span>Liquidity_p[_Liquidity<span class="op">&gt;</span>Liquidity_p]<span class="op">+</span>shares[_Liquidity<span class="op">&gt;</span>Liquidity_p]<span class="op">*</span>(_Liquidity[_Liquidity<span class="op">&gt;</span>Liquidity_p]<span class="op">-</span>Liquidity_p[_Liquidity<span class="op">&gt;</span>Liquidity_p])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="augment-panel-age" class="level2">
<h2 class="anchored" data-anchor-id="augment-panel-age">Augment panel age</h2>
<p>This short function augments the age of all solar panels in the model by one period. If the panel of an agent has reached its maximum age, the value of <code>_PV</code> is set to zero for that agent, as is the value of <code>_PanelAge</code> and <code>_PanelFIT</code> which gives the FIT received. The agent is then no longer a PV owner and will face the adoption decision again.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> AugmentPanelAge(_PV,_PanelAge,_PanelFIT,_Params):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    _PanelAge[_PV<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span>_PanelAge[_PV<span class="op">==</span><span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    _PV[_PanelAge<span class="op">&gt;</span>_Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    _PanelFIT[_PanelAge<span class="op">&gt;</span>_Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    _PanelAge[_PanelAge<span class="op">&gt;</span>_Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[_PanelAge,_PV,_PanelFIT]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="expectations-formation" class="level2">
<h2 class="anchored" data-anchor-id="expectations-formation">Expectations formation</h2>
<p>This function is used to generate a time-series of expected future electricity prices for each agents. These are needed below when agents decide whether or not to adopt PV.</p>
<p>Expectations formation of our bounded rational agents takes place using the well-established recursive least squares algorithm. Each agent has their own “internal” AR(1) model of the electricity price, the coefficients of which they update in every period using the latest observation of the actual electricity price in the model. Depending on the parameter setting, each individual agents may use a specific gain parameter to update their estimations, in which case the expected electricity prices differ across agents. In particular, agents with a high gain parameter will tend to update their estimated coefficients more strongly in reaction to new information, while agents with a low gain parameter will react less.</p>
<p>The first part of the function updates the internal AR(1) models of the agents, while the second projects the models to generate time-series of a length equal to the maximum lifespan of a solar panel. The function then returns the coefficients variance-covariance matrices of the updated AR(1) models and the time-series of expected prices.</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> FormExpectation(_ARPars,_ARMats,_Price,_Gain,_ExpectedPrice,_period):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate vector of independent variables --&gt; constant=1 and current change in price</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    independent<span class="op">=</span>np.array([[<span class="dv">1</span>],[(_Price[(_period<span class="op">+</span><span class="dv">1</span>)]<span class="op">-</span>_Price[_period])]])</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update variance-covariance matrices following recursive least squares algorithm</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    mat1<span class="op">=</span>np.dot(independent,independent.transpose())</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    ARMatsNew<span class="op">=</span>_ARMats<span class="op">+</span>_Gain[:,<span class="va">None</span>,<span class="va">None</span>]<span class="op">*</span>(mat1<span class="op">-</span>_ARMats)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Test for singularity of updated matrices</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    test<span class="op">=</span>np.linalg.det(ARMatsNew)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="bu">sum</span>(test<span class="op">==</span><span class="dv">0</span>)<span class="op">&gt;</span><span class="dv">0</span>):</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">'One or more matrices are singular!'</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#If updated matrix of an agent is singular, use old matrix</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    _ARMats[np.where(test<span class="op">!=</span><span class="dv">0</span>)]<span class="op">=</span>ARMatsNew[np.where(test<span class="op">!=</span><span class="dv">0</span>)]</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update coefficient estimates of agents' AR(1) models</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    transposes<span class="op">=</span>_ARPars.swapaxes(<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    result1<span class="op">=</span>np.dot(transposes,independent)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    dependent<span class="op">=</span>_Price[(_period<span class="op">+</span><span class="dv">2</span>)]<span class="op">-</span>_Price[(_period<span class="op">+</span><span class="dv">1</span>)]</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    result1<span class="op">=</span>dependent<span class="op">-</span>result1</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    result1<span class="op">=</span>independent<span class="op">*</span>result1</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    result1<span class="op">=</span>np.linalg.solve(_ARMats,result1)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    _ARPars<span class="op">=</span>_ARPars<span class="op">+</span>_Gain[:,<span class="va">None</span>,<span class="va">None</span>]<span class="op">*</span>result1</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    transposes1<span class="op">=</span>_ARPars[:,<span class="dv">0</span>].transpose()</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    transposes2<span class="op">=</span>_ARPars[:,<span class="dv">1</span>].transpose()</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate time-series of expected electricity price for each agent</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    _ExpectedPrice[:,<span class="dv">0</span>]<span class="op">=</span>(_Price[(_period<span class="op">+</span><span class="dv">2</span>)]<span class="op">+</span>_ARPars[:,<span class="dv">0</span>]<span class="op">+</span>_ARPars[:,<span class="dv">1</span>]<span class="op">*</span>(_Price[(_period<span class="op">+</span><span class="dv">2</span>)]<span class="op">-</span>_Price[(_period<span class="op">+</span><span class="dv">1</span>)])).transpose()</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    _ExpectedPrice[:,<span class="dv">1</span>]<span class="op">=</span>_ExpectedPrice[:,<span class="dv">0</span>]<span class="op">+</span>transposes1<span class="op">+</span>transposes2<span class="op">*</span>(_ExpectedPrice[:,<span class="dv">0</span>]<span class="op">-</span>_Price[(_period<span class="op">+</span><span class="dv">2</span>)])</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>,<span class="bu">len</span>(_ExpectedPrice[<span class="dv">0</span>])):</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        _ExpectedPrice[:,t]<span class="op">=</span>_ExpectedPrice[:,(t<span class="op">-</span><span class="dv">1</span>)]<span class="op">+</span>transposes1<span class="op">+</span>transposes2<span class="op">*</span>(_ExpectedPrice[:,(t<span class="op">-</span><span class="dv">1</span>)]<span class="op">-</span>_ExpectedPrice[:,(t<span class="op">-</span><span class="dv">2</span>)])</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[_ARMats,_ARPars,_ExpectedPrice]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="adoption-decision" class="level2">
<h2 class="anchored" data-anchor-id="adoption-decision">Adoption Decision</h2>
<p>In this function, agents who do not yet own PV decide whether or not to purchase a panel.</p>
<p>The function first checks which agents would need a loan in order to adopt PV (namely those who do not have sufficient liquid assets to buy one outright). Based on the size of the loan needed, agents may be credit rationed if the resulting loan to value ratio exceeds the maximum permitted level (note that in the current implementation, <code>_Params["MaxLTV"]=1</code> such that this rationing mechanism is effectively switched off).</p>
<p>Next, the bank proposes a loan interest rate to every agent with positive borrowing needs based on the size of the required loan. From this, in turn, we calculate the size of the implied debt service payment. If the prospective debt service payment of an agent exceeds a certain fraction (<code>_Params["MaxDTI"]</code>) of their current income, the agent is credit rationed. Since the model only includes a single type of solar panel with a given installation cost, credit rationed agents cannot adopt (i.e.&nbsp;they cannot, for instance, buy a smaller panel with a smaller loan).</p>
<p>The function then calculates, for each agent, a sum of expected discounted revenue from owning PV over the lifetime of a panel, based on agents’ expected future electricity prices, the value of the feed-in tariff for panels installed in the current year, agents’ future electricity consumption (which, as outlined above, grows at a fixed rate every year), as well as a sum of discounted future loan costs based on the size of the needed loan and the interest rate proposed by the bank. As in the case of the function <code>IncomePowercost</code> outlined above, in calculating the expected cost-saving/revenue from owning PV, agents are divided into groups depending on whether their future electricity consumption is larger or smaller than the capacity of the solar panel and whether the current FIT is larger or smaller than the expected electricity price. Based on the cumulative discounted expected revenue and loan cost and the one-off installation cost, an expected profit from owning PV is calculated.</p>
<p>This expected profit, in turn, feeds into the expected utility from adopting PV. In addition to profit, this utility also contains a component related to social influence (based on the difference between the share of other agents in a given agent’s income decile who have already adopted PV and those who have not) and one related to environmental attitude.</p>
<p>Agents for whom expected utility is positive (and for whom PV is technically feasible and who are not credit-rationed) purchase a solar panel and their liquidity, debt, debt service payments and loan rates are updated accordingly.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> AdoptionDecision(_PV,_Feasible,_Liquidity,_Rationed,_Debt,_Income,_Income_f,_Powercost_f,_Trend,_ExpectedPrice,_Discount,_Revenue,_LoanCost,_PVOwnershipDeciles,_IncomeDeciles,_LoanRate,_DebtService,_Influence,_Attitude,_Adopted,_CumulativeProfit,_FIT,_year,_PanelFIT,_Baserate,_Subsidy1,_Subsidy2,_CreditPolicy1,_CreditPolicy2,_Params):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Reset vector of dummies indicating whether agents are credit-rationed</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    _Rationed[:]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate loan needed to purchase PV</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    loanneeded<span class="op">=</span>(<span class="dv">1</span><span class="op">-</span>_Subsidy1)<span class="op">*</span>_Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>]<span class="op">-</span>_Liquidity</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who already have PV do not need a loan</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    loanneeded[_PV<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who can buy the panel outright do not need a loan</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    loanneeded[(_PV<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (_Liquidity<span class="op">&gt;=</span>((<span class="dv">1</span><span class="op">-</span>_Subsidy1)<span class="op">*</span>_Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>]))]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents for whom PV is not technically feasible do not need a loan</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    loanneeded[_Feasible<span class="op">==</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Check whether needed loan exceeds maximum loan to value ratio</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    _Rationed[(loanneeded<span class="op">+</span>_Debt)<span class="op">&gt;</span>((<span class="dv">1</span><span class="op">-</span>_Subsidy1)<span class="op">*</span>_Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(_Params[<span class="st">"MaxLTV"</span>].values[<span class="dv">0</span>]<span class="op">+</span>_CreditPolicy1))]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate interest rate proposed by the bank based on size of loan needed</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    proposedrate<span class="op">=</span>_Baserate[<span class="bu">str</span>(_year)].values[<span class="dv">0</span>]<span class="op">+</span>_Params[<span class="st">"InterestMarkup"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>loanneeded<span class="op">/</span>((<span class="dv">1</span><span class="op">-</span>_Subsidy1)<span class="op">*</span>_Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>]<span class="op">*</span>_Params[<span class="st">"MaxLTV"</span>].values[<span class="dv">0</span>]))</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate size of debt service payments</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    payment<span class="op">=</span>loanneeded<span class="op">*</span>(proposedrate<span class="op">*</span>(np.power(<span class="dv">1</span><span class="op">+</span>proposedrate,_Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>])))<span class="op">/</span>((np.power(<span class="dv">1</span><span class="op">+</span>proposedrate,_Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]))<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Check whether implied debt service to income ratio exceeds maximum permitted</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    _Rationed[(payment<span class="op">/</span>_Income)<span class="op">&gt;</span>(_Params[<span class="st">"MaxDTI"</span>].values[<span class="dv">0</span>]<span class="op">+</span>_CreditPolicy2)]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who do not need a loan are not rationed</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    _Rationed[loanneeded<span class="op">==</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents for whom PV is not technically feasible are not rationed</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    _Rationed[_Feasible<span class="op">==</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who already own PV are not rationed</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    _Rationed[_PV<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise expected revenue from PV and cost of loan</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    _Revenue[:]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    _LoanCost[:]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise cost saving from PV</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    costsaving<span class="op">=</span>_Revenue.copy()</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initial remaining loan balance is equal to size of loan needed</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    balanceremaining<span class="op">=</span>loanneeded.copy()</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Iterate over lifespan of a solar panel</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(_Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]):</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        costsaving[:]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Agents whose expected electricity consumption exceeds the capacity of the panel and for whom the current FIT is smaller than the expected electricity price</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        group1<span class="op">=</span>np.where((_ExpectedPrice[:,t]<span class="op">&gt;=</span>(_FIT[<span class="bu">str</span>(_year)].values[<span class="dv">0</span>]<span class="op">+</span>_Subsidy2)) <span class="op">&amp;</span> ((_Powercost_f<span class="op">*</span>np.power((<span class="dv">1</span><span class="op">+</span>_Trend),t))<span class="op">&gt;=</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]))</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Agents whose expected electricity consumption is smaller than the capacity of the panel and for whom the current FIT is smaller than the expected electricity price</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        group2<span class="op">=</span>np.where((_ExpectedPrice[:,t]<span class="op">&gt;=</span>(_FIT[<span class="bu">str</span>(_year)].values[<span class="dv">0</span>]<span class="op">+</span>_Subsidy2)) <span class="op">&amp;</span> ((_Powercost_f<span class="op">*</span>np.power((<span class="dv">1</span><span class="op">+</span>_Trend),t))<span class="op">&lt;</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]))</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Agents whose expected electricity consumption exceeds the capacity of the panel and for whom the current FIT is larger than the expected electricity price</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        group3<span class="op">=</span>np.where((_ExpectedPrice[:,t]<span class="op">&lt;</span>(_FIT[<span class="bu">str</span>(_year)].values[<span class="dv">0</span>]<span class="op">+</span>_Subsidy2)) <span class="op">&amp;</span> ((_Powercost_f<span class="op">*</span>np.power((<span class="dv">1</span><span class="op">+</span>_Trend),t))<span class="op">&gt;=</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]))</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Agents whose expected electricity consumption is smaller than the capacity of the panel and for whom the current FIT is larger than the expected electricity price</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        group4<span class="op">=</span>np.where((_ExpectedPrice[:,t]<span class="op">&lt;</span>(_FIT[<span class="bu">str</span>(_year)].values[<span class="dv">0</span>]<span class="op">+</span>_Subsidy2)) <span class="op">&amp;</span> ((_Powercost_f<span class="op">*</span>np.power((<span class="dv">1</span><span class="op">+</span>_Trend),t))<span class="op">&lt;</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]))</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">#expected cost saving for group 1 is given by share of own consumption times capacity times expected price plus electricity fed into the grid times FIT</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        costsaving[group1]<span class="op">=</span>_ExpectedPrice[group1,t]<span class="op">*</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">*</span>_Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>]<span class="op">+</span>(<span class="dv">1</span><span class="op">-</span>_Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>])<span class="op">*</span>(_FIT[<span class="bu">str</span>(_year)].values[<span class="dv">0</span>]<span class="op">+</span>_Subsidy2)<span class="op">*</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">#expected cost saving for group 2 is given by minimum between own consumption share times capacity times expected price and expected electricity consumption times expected price, plus the remaining capacity of the panel times FIT</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>        costsaving[group2]<span class="op">=</span>_ExpectedPrice[group2,t]<span class="op">*</span>np.minimum(_Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>]<span class="op">*</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>],_Powercost_f[group2]<span class="op">*</span>np.power((<span class="dv">1</span><span class="op">+</span>_Trend[group2]),t))<span class="op">+</span>(_FIT[<span class="bu">str</span>(_year)].values[<span class="dv">0</span>]<span class="op">+</span>_Subsidy2)<span class="op">*</span>(_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">-</span>np.minimum(_Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>]<span class="op">*</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>],_Powercost_f[group2]<span class="op">*</span>np.power((<span class="dv">1</span><span class="op">+</span>_Trend[group2]),t)))</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">#expected cost saving for groups 3 and 4 is equal to FIT times capacity of the solar panel</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        costsaving[group3]<span class="op">=</span>(_FIT[<span class="bu">str</span>(_year)].values[<span class="dv">0</span>]<span class="op">+</span>_Subsidy2)<span class="op">*</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        costsaving[group4]<span class="op">=</span>(_FIT[<span class="bu">str</span>(_year)].values[<span class="dv">0</span>]<span class="op">+</span>_Subsidy2)<span class="op">*</span>_Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Discounted value of expected cost saving is added to cumulative expected revenue</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        _Revenue<span class="op">=</span>_Revenue<span class="op">+</span>costsaving<span class="op">/</span>(np.power(<span class="dv">1</span><span class="op">+</span>_Discount,t))</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Expected interest cost</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        cost<span class="op">=</span>proposedrate<span class="op">*</span>balanceremaining</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Remaining loan balance</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>        balanceremaining<span class="op">=</span>balanceremaining<span class="op">-</span>(payment<span class="op">-</span>cost)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Discounted interest cost is added to cumulative expected cost of the loan</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>        _LoanCost<span class="op">=</span>_LoanCost<span class="op">+</span>cost<span class="op">/</span>(np.power(<span class="dv">1</span><span class="op">+</span>_Discount,t))</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Expected profit from PV ownership is given by cumulative discounted expected revenue minus installation cost (possibly reduced by subsidy) minus cumulative expected discounted cost of the loan</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    profit<span class="op">=</span>_Revenue<span class="op">-</span>((<span class="dv">1</span><span class="op">-</span>_Subsidy1)<span class="op">*</span>_Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>])<span class="op">-</span>_LoanCost</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">#For each agent, set variable deciles to the PV ownership rate in their own income decile</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>    deciles<span class="op">=</span>_PVOwnershipDeciles[_IncomeDeciles.astype(<span class="bu">int</span>)]</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Utility depends on profit, social influence component (deciles=share of other agents in decile who already have PV) and environmental attitude</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    utility<span class="op">=</span>profit<span class="op">+</span>_Influence<span class="op">*</span>(deciles<span class="op">-</span>(<span class="dv">1</span><span class="op">-</span>deciles))<span class="op">+</span>_Params[<span class="st">"Beta"</span>].values[<span class="dv">0</span>]<span class="op">*</span>_Attitude</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Assume that agents who had already adopted PV before but whose panel has reached maximum age will only consider expected profit when deciding whether to re-adopt</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    utility[(_Adopted<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (_CumulativeProfit<span class="op">&gt;</span><span class="dv">0</span>) <span class="op">&amp;</span> (_PV<span class="op">==</span><span class="dv">0</span>)]<span class="op">=</span>profit</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Re-set cumulative profit for agents who made a loss over the lifetime of their panel to 0</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    _CumulativeProfit[(_Adopted<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (_CumulativeProfit<span class="op">&lt;=</span><span class="dv">0</span>) <span class="op">&amp;</span> (_PV<span class="op">==</span><span class="dv">0</span>)]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who are credit rationed will not adopt</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    utility[_Rationed<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents for whom PV is not technically feasible will not adopt</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    utility[_Feasible<span class="op">==</span><span class="dv">0</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Agents who already own PV will not adopt</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>    utility[_PV<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Find agents who will adopt</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>    adopters<span class="op">=</span>np.where(utility<span class="op">&gt;</span><span class="dv">0</span>)</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Find adopters who need a loan</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>    borrowers<span class="op">=</span>np.where((utility<span class="op">&gt;</span><span class="dv">0</span>) <span class="op">&amp;</span> (loanneeded<span class="op">&gt;</span><span class="dv">0</span>))</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set PV dummy for adopters to 1</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>    _PV[adopters]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set FIT for adopters (will be unchanged over the lifetime of the panel!)</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>    _PanelFIT[adopters]<span class="op">=</span>_FIT[<span class="bu">str</span>(_year)].values[<span class="dv">0</span>]</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Indicates whether agent adopted PV at any point during the run; set to 1 for adopters</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>    _Adopted[adopters]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Re-initialise cumulative profit for adopters</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>    _CumulativeProfit[adopters]<span class="op">=-</span>((<span class="dv">1</span><span class="op">-</span>_Subsidy1)<span class="op">*</span>_Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>])</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Update liquidity for adopters, possibly including loan needed</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>    _Liquidity[adopters]<span class="op">=</span>_Liquidity[adopters]<span class="op">-</span>((<span class="dv">1</span><span class="op">-</span>_Subsidy1)<span class="op">*</span>_Params[<span class="st">"PanelCost"</span>].values[<span class="dv">0</span>])<span class="op">+</span>loanneeded[adopters]</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set loan rate for borrowers</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>    _LoanRate[borrowers]<span class="op">=</span>proposedrate[borrowers]<span class="op">*</span>loanneeded[borrowers]<span class="op">/</span>(loanneeded[borrowers]<span class="op">+</span>_Debt[borrowers])<span class="op">+</span>_LoanRate[borrowers]<span class="op">*</span>_Debt[borrowers]<span class="op">/</span>(loanneeded[borrowers]<span class="op">+</span>_Debt[borrowers])</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set debt level and debt service payments for borrowers</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>    _Debt[borrowers]<span class="op">=</span>_Debt[borrowers]<span class="op">+</span>loanneeded[borrowers]</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>    _DebtService[borrowers]<span class="op">=</span>_Debt[borrowers]<span class="op">*</span>(_LoanRate[borrowers]<span class="op">*</span>(np.power(<span class="dv">1</span><span class="op">+</span>_LoanRate[borrowers],_Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>])))<span class="op">/</span>((np.power(<span class="dv">1</span><span class="op">+</span>_LoanRate[borrowers],_Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]))<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[_PV,_Rationed,_Liquidity,_LoanRate,_Debt,_DebtService,_Adopted,_CumulativeProfit,_PanelFIT]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="pv-deciles" class="level2">
<h2 class="anchored" data-anchor-id="pv-deciles">PV Deciles</h2>
<p>This function calculates the share of agents who own PV in each decile. It is called at the end of a simulation period and, because an initial value is needed for the adoption decision in the first simulation period, once after function <code>IncomeGroups</code> during the first simulation period. It determines the overall number of agents in each income decile as well as the number of agents owning PV in each decile in order to calculate a PV ownership rate for each decile.</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> PVDeciles(_Income_p,_PV,_Positions_d,_Deciles,_PVOwnershipDeciles,_DecileMembers):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Sort vector of income net of electricity cost in ascending order</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    income_psorted<span class="op">=</span>np.sort(_Income_p)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Based on sorted income and number of agents in each decile, set cut-off points</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    _Deciles[<span class="dv">0</span>:<span class="dv">9</span>]<span class="op">=</span>income_psorted[_Positions_d]</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    _Deciles[<span class="dv">9</span>]<span class="op">=</span>income_psorted[((income_psorted.size)<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Iterate over deciles</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Determine which agents belong to decile i</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i<span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>            members<span class="op">=</span>np.where(_Income_p<span class="op">&lt;=</span>_Deciles[i])</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            members<span class="op">=</span>np.where((_Income_p<span class="op">&lt;=</span>_Deciles[i]) <span class="op">&amp;</span> (_Income_p<span class="op">&gt;</span>_Deciles[(i<span class="op">-</span><span class="dv">1</span>)]))</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set the number of agents in decile i</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        _DecileMembers[i]<span class="op">=</span>members[<span class="dv">0</span>].size</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set the number of agents owning PV in decile i</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        _PVOwnershipDeciles[i]<span class="op">=</span>_PV[members[<span class="dv">0</span>]].<span class="bu">sum</span>()</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Calculate ownership rate by decile</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    _PVOwnershipDeciles<span class="op">=</span>_PVOwnershipDeciles<span class="op">/</span>_DecileMembers</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>[_PVOwnershipDeciles]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="calculate-statistics" class="level2">
<h2 class="anchored" data-anchor-id="calculate-statistics">Calculate statistics</h2>
<p>This function calculates a range of statistics, time-series of which will be returned by the main function at the end of a simulation.</p>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> CalculateStatistics(_PV,_Income,_Debt,_Liquidity,_ExpectedPrice,_Feasible,_Rationed):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Average income</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    averageincome<span class="op">=</span>np.<span class="bu">sum</span>(_Income)<span class="op">/</span>_Income.size</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Average Liquidity</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    averageliquidity<span class="op">=</span>np.<span class="bu">sum</span>(_Liquidity)<span class="op">/</span>_Liquidity.size</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Average expected price in t+1</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    averageexpectedprice<span class="op">=</span>np.<span class="bu">sum</span>(_ExpectedPrice)<span class="op">/</span>_ExpectedPrice.size</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Average debt, only taking into account agents with positive debt</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.<span class="bu">sum</span>(_Debt<span class="op">&gt;</span><span class="dv">0</span>)<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        averagedebt<span class="op">=</span>np.<span class="bu">sum</span>(_Debt[_Debt<span class="op">&gt;</span><span class="dv">0</span>])<span class="op">/</span>np.<span class="bu">sum</span>(_Debt<span class="op">&gt;</span><span class="dv">0</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        averagedebt<span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Adoption rate taking into account all agents</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    adoptionrate1<span class="op">=</span>np.<span class="bu">sum</span>(_PV)<span class="op">/</span>_PV.size</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Adoption rate taking into account only agents for whom PV is technically feasible</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.<span class="bu">sum</span>(_Feasible)<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        adoptionrate2<span class="op">=</span>np.<span class="bu">sum</span>(_PV)<span class="op">/</span>np.<span class="bu">sum</span>(_Feasible)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        adoptionrate2<span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Share of agents who are credit-rationed</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> np.<span class="bu">sum</span>((_PV<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (_Feasible<span class="op">==</span><span class="dv">1</span>))<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        rationing<span class="op">=</span>np.<span class="bu">sum</span>(_Rationed)<span class="op">/</span>np.<span class="bu">sum</span>((_PV<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (_Feasible<span class="op">==</span><span class="dv">1</span>))</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        rationing<span class="op">=</span><span class="dv">0</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(averageincome,averageliquidity,averageexpectedprice,averagedebt,adoptionrate1,adoptionrate2,rationing)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="main-model-function" class="level2">
<h2 class="anchored" data-anchor-id="main-model-function">Main model function</h2>
<p>This is the function which must be called to execute the model. It takes several inputs, namely:</p>
<div class="incremental">
<ul class="incremental">
<li><code>inputfile</code> - a csv file containing a a list of all model households and their initial characteristics</li>
<li><code>propensitiesfile</code> - a csv file containing propensities to consume out of income by income percentile</li>
<li><code>liquiditysharesfile</code> - a csv file containing the shares of saving going into liquid assets by income percentile</li>
<li><code>fitfile</code> - a csv containing the value of the feed-in tariff for solar panels installed in each simulation year</li>
<li><code>costfile</code> - a csv containing an annual time-series of installation cost of a solar panel</li>
<li><code>ratefile</code> - a csv containing an annual time-series of central bank base interest rates</li>
<li><code>pricefile</code> - a csv containing an annual time-series of electricity prices</li>
<li><code>paramfile</code> - a csv file containing the names and values of all model parameters</li>
<li><code>seed</code> - a seed for the pseudo-random number generator</li>
<li><code>start</code> - the start year of the model simulation</li>
<li><code>end</code> - the end year of the model simulation</li>
</ul>
</div>
<p>The function begins by setting the seed for the pseudo-random number generator, and then loads all necessary external input files. It then initialises the model by generating vectors/arrays of all model variables and setting initial values where necessary.</p>
<p>Subsequently, there is a single call to <code>GenerateElectricityPrice</code> in order to generate a time-series of electricity prices for the current model run. Subsequently, one of the electricity price time-series is used to train the agents’ expectations formation algorithm. After this, the main simulation loop is entered. In each simulation period, the model calls the functions described above one after the other, updating the relevant model variables based on the outputs of each function.</p>
<p>At the end of the simulation run, the time-series of aggregate statistics to be returned are stacked into a single array and converted to a dataframe, which is then saved in csv format, with the seed number attached to the file name. Similarly, the time-series of PV adoption rates by income decile are saved in csv format, with the seed number attached to the file name.</p>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> PVModel(inputfile<span class="op">=</span><span class="st">"inputs.csv"</span>,propensitiesfile<span class="op">=</span><span class="st">"consumptionpropensities.csv"</span>,liquiditysharesfile<span class="op">=</span><span class="st">"liquidityshares.csv"</span>,fitfile<span class="op">=</span><span class="st">"FIT.csv"</span>,costfile<span class="op">=</span><span class="st">"pvcost.csv"</span>,ratefile<span class="op">=</span><span class="st">"baserate.csv"</span>,pricefile<span class="op">=</span><span class="st">"electricityprice.csv"</span>,paramfile<span class="op">=</span><span class="st">"parameters.csv"</span>,seed<span class="op">=</span><span class="dv">1</span>,runname<span class="op">=</span><span class="st">"test"</span>,start<span class="op">=</span><span class="dv">2018</span>,end<span class="op">=</span><span class="dv">2040</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set seed</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Load external input files</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    Inputs<span class="op">=</span>pd.read_csv(inputfile)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    Params<span class="op">=</span>pd.read_csv(paramfile)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    Propensities<span class="op">=</span>np.ndarray.flatten(pd.read_csv(propensitiesfile,header<span class="op">=</span><span class="va">None</span>).to_numpy())</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    LiquidityShares<span class="op">=</span>np.ndarray.flatten(pd.read_csv(liquiditysharesfile,header<span class="op">=</span><span class="va">None</span>).to_numpy())</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    FIT<span class="op">=</span>pd.read_csv(fitfile)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    PVCost<span class="op">=</span>pd.read_csv(costfile)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    Baserate<span class="op">=</span>pd.read_csv(ratefile)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    PriceEmp<span class="op">=</span>pd.read_csv(pricefile)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise deterministic mean values for income</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    Income_f<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"income"</span>]].to_numpy())</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create matrix for actual income</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    Income<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),(end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)))</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create matrix for income net of power cost</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    Income_p<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),(end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)))</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set values for standard deviation of income</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    Income_sd<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"incomesd"</span>]].to_numpy())</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise deterministic values of electricity consumption</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    Powercost_f<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"powercons"</span>]].to_numpy())</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create matrix for actual power cost (including price)</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    Powercost<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),(end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)))</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector for current consumption</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    Consumption<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create matrix for liquidity and set initial values</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    Liquidity<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),(end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)))</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    Liquidity[:,<span class="dv">0</span>]<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"liquidity"</span>]].to_numpy())</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vectors for debt, debt service payments and loan rates</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    Debt<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    DebtService<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    LoanRate<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set trend rates at which electricity consumption and mean values of income will grow</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    Trend<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"trend"</span>]].to_numpy())</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set housing dummy (1=agent lives in house, 0=agent lives in flat)</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    House<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"house"</span>]].to_numpy())</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create matrix for current PV ownership dummies and set initial values (1=currently owns PV)</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    PV<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),(end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)))</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    PV[:,<span class="dv">0</span>]<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"pv"</span>]].to_numpy())</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise age of solar panels</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    PanelAge<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"panelage"</span>]].to_numpy())</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set environmental attitudes</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    Attitude<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"attitude"</span>]].to_numpy())</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set strength of social influence for each agent</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    Influence<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="bu">len</span>(Inputs.index))<span class="op">*</span>(Params[<span class="st">"MaxInfluence"</span>].values[<span class="dv">0</span>]<span class="op">-</span>Params[<span class="st">"MinInfluence"</span>].values[<span class="dv">0</span>])<span class="op">+</span>Params[<span class="st">"MinInfluence"</span>].values[<span class="dv">0</span>]</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set discount rate for each agent</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    Discount<span class="op">=</span>np.ndarray.flatten(Inputs[[<span class="st">"discount"</span>]].to_numpy())</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector of dummies indicating whether PV is technically feasible</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    Feasible<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">#If agent already owns PV, it is feasible</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    Feasible[PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">#If agent lives in house, it is feasible</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    Feasible[House<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">#If agent lives in flat, PV is feasible with a certain probability</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>    Feasible[(House<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">0</span>)]<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="bu">sum</span>((House<span class="op">==</span><span class="dv">0</span>) <span class="op">&amp;</span> (PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">0</span>)))</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>    Feasible[Feasible<span class="op">&gt;=</span>(<span class="dv">1</span><span class="op">-</span>Params[<span class="st">"FeasibilityProb"</span>].values[<span class="dv">0</span>])]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    Feasible[Feasible<span class="op">&lt;</span>(<span class="dv">1</span><span class="op">-</span>Params[<span class="st">"FeasibilityProb"</span>].values[<span class="dv">0</span>])]<span class="op">=</span><span class="dv">0</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector to hold feed-in tariffs earned by each agent</span></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    PanelFIT<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Find the oldest existing panel</span></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    maxage<span class="op">=</span><span class="bu">max</span>(PanelAge)</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> a <span class="kw">in</span> <span class="bu">range</span>(maxage<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set the adoption year</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>        yearadopted<span class="op">=</span>start<span class="op">-</span>(a<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>        <span class="co">#If the adoption year is within the range of the time-series of FITs, set the FIT of all agents who adopted in that year to the appropriate value</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">sum</span>(<span class="bu">str</span>(yearadopted)<span class="op">==</span>FIT.columns)<span class="op">==</span><span class="dv">1</span>:</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>            PanelFIT[(PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (PanelAge<span class="op">==</span>a)]<span class="op">=</span>FIT[<span class="bu">str</span>(yearadopted)].values[<span class="dv">0</span>]</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Otherwise, set the FIT to the earliest available value</span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>            PanelFIT[(PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (PanelAge<span class="op">==</span>a)]<span class="op">=</span>FIT.iloc[<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set the cutoff points for income percentiles</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>    Positions_p<span class="op">=</span>np.zeros(<span class="dv">99</span>)</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>    Positions_p[:]<span class="op">=</span>np.array(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">100</span>,<span class="dv">1</span>))<span class="op">*</span>(<span class="bu">len</span>(Inputs.index)<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">100</span><span class="op">-</span><span class="dv">1</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>    Positions_p<span class="op">=</span>np.<span class="bu">round</span>(Positions_p)</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>    Positions_p<span class="op">=</span>Positions_p.astype(<span class="bu">int</span>)</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector to hold income value associated with each percentile</span></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>    Percentiles<span class="op">=</span>np.zeros(<span class="dv">100</span>)</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set the cutoff points for income deciles</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>    Positions_d<span class="op">=</span>np.zeros(<span class="dv">9</span>)</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>    Positions_d[:]<span class="op">=</span>np.array(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">1</span>))<span class="op">*</span>(<span class="bu">len</span>(Inputs.index)<span class="op">+</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">10</span><span class="op">-</span><span class="dv">1</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    Positions_d<span class="op">=</span>np.<span class="bu">round</span>(Positions_d)</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>    Positions_d<span class="op">=</span>Positions_d.astype(<span class="bu">int</span>)</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector to hold income value associated with each decile</span></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>    Deciles<span class="op">=</span>np.zeros(<span class="dv">10</span>)</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector to hold number of agents in each decile</span></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    DecileMembers<span class="op">=</span>np.zeros(<span class="dv">10</span>)</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector to hold PV ownership rate in each decile</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    PVOwnershipDeciles<span class="op">=</span>np.zeros(<span class="dv">10</span>)</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vectors to hold the income deciles and percentiles of each agent</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>    IncomeDeciles<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>    IncomePercentiles<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set the gain parameter used by each agent in the recursive least squares learning algorithm</span></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>    Gain<span class="op">=</span>np.random.uniform(<span class="dv">0</span>,<span class="dv">1</span>,<span class="bu">len</span>(Inputs.index))<span class="op">*</span>(Params[<span class="st">"MaxGain"</span>].values[<span class="dv">0</span>]<span class="op">-</span>Params[<span class="st">"MinGain"</span>].values[<span class="dv">0</span>])<span class="op">+</span>Params[<span class="st">"MinGain"</span>].values[<span class="dv">0</span>]</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise agents' estimates of parameters and variance-covariance matrices</span></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>    ARPars<span class="op">=</span>np.array([[Params[<span class="st">"ElectricityPriceTrend"</span>].values[<span class="dv">0</span>]],[Params[<span class="st">"ElectricityPriceAR"</span>].values[<span class="dv">0</span>]]])</span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>    ARPars<span class="op">=</span>[ARPars]<span class="op">*</span><span class="bu">len</span>(Inputs.index)</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>    ARPars<span class="op">=</span>np.array(ARPars)</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>    ARMats<span class="op">=</span>np.array([[Params[<span class="st">"ElectricityPriceMat11"</span>].values[<span class="dv">0</span>],Params[<span class="st">"ElectricityPriceMat12"</span>].values[<span class="dv">0</span>]],[Params[<span class="st">"ElectricityPriceMat21"</span>].values[<span class="dv">0</span>],Params[<span class="st">"ElectricityPriceMat22"</span>].values[<span class="dv">0</span>]]])</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>    ARMats<span class="op">=</span>[ARMats]<span class="op">*</span><span class="bu">len</span>(Inputs.index)</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>    ARMats<span class="op">=</span>np.array(ARMats)</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create a matrix to hold agents' expected electricity prices</span></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>    ExpectedPrice<span class="op">=</span>np.zeros(shape<span class="op">=</span>(<span class="bu">len</span>(Inputs.index),Params[<span class="st">"PVMaxAge"</span>].values[<span class="dv">0</span>]))</span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise policy variables</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Subsidy on purchase price of panel</span></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>    Subsidy1<span class="op">=</span><span class="dv">0</span></span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Additional subsidy on FIT</span></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>    Subsidy2<span class="op">=</span><span class="dv">0</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Change in maximum loan to value ratio</span></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>    CreditPolicy1<span class="op">=</span><span class="dv">0</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Change in maximum debt service to income ratio</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>    CreditPolicy2<span class="op">=</span><span class="dv">0</span></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector to hold expected discounted cumulative revenue from owning PV</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>    Revenue<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector to hold expected discounted cumulative loan cost to purchase PV</span></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>    LoanCost<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector to hold dummies indicating whether agents are credit-rationed</span></span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>    Rationed<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector to hold actual cumulative profit derived from owning PV</span></span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>    CumulativeProfit<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Create vector of dummies indicating whether agent has at any point owned PV</span></span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>    Adopted<span class="op">=</span>np.zeros(<span class="bu">len</span>(Inputs.index))</span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set initial values for agents already owning PV at the start of the simulation</span></span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>    Adopted[PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>]<span class="op">=</span><span class="dv">1</span></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>    <span class="co">#To initialise the cumulative profit on pre-existing solar panels, we divide agents owning PV into 4 groups</span></span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Group 1 contains agents who own PV, whose electricity consumption is greater than the capacity of the panel, and whose FIT is lower than the starting value of the electricity price</span></span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>    group1<span class="op">=</span>np.where((PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (Powercost_f<span class="op">&gt;=</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]) <span class="op">&amp;</span> ((PanelFIT<span class="op">+</span>Subsidy2)<span class="op">&lt;</span>PriceEmp[<span class="bu">str</span>(start<span class="op">-</span><span class="dv">1</span>)].values[<span class="dv">0</span>]))</span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Group 2 contains agents who own PV, whose electricity consumption is greater than the capacity of the panel, and whose FIT is higher than the starting value of the electricity price</span></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>    group2<span class="op">=</span>np.where((PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (Powercost_f<span class="op">&gt;=</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]) <span class="op">&amp;</span> ((PanelFIT<span class="op">+</span>Subsidy2)<span class="op">&gt;=</span>PriceEmp[<span class="bu">str</span>(start<span class="op">-</span><span class="dv">1</span>)].values[<span class="dv">0</span>]))</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Group 3 contains agents who own PV, whose electricity consumption is smaller than the capacity of the panel, and whose FIT is lower than the starting value of the electricity price</span></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>    group3<span class="op">=</span>np.where((PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (Powercost_f<span class="op">&lt;</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]) <span class="op">&amp;</span> ((PanelFIT<span class="op">+</span>Subsidy2)<span class="op">&lt;</span>PriceEmp[<span class="bu">str</span>(start<span class="op">-</span><span class="dv">1</span>)].values[<span class="dv">0</span>]))</span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Group 4 contains agents who own PV, whose electricity consumption is lower than the capacity of the panel, and whose FIT is higher than the starting value of the electricity price</span></span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>    group4<span class="op">=</span>np.where((PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (Powercost_f<span class="op">&lt;</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]) <span class="op">&amp;</span> ((PanelFIT<span class="op">+</span>Subsidy2)<span class="op">&gt;=</span>PriceEmp[<span class="bu">str</span>(start<span class="op">-</span><span class="dv">1</span>)].values[<span class="dv">0</span>]))</span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Cumulative profit of agents in group 1 is initialised as share of own consumption times capacity of the panel times initial electricity price plus remaining capacity times FIT</span></span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>    CumulativeProfit[group1]<span class="op">=</span>Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>]<span class="op">*</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">*</span>PriceEmp[<span class="bu">str</span>(start<span class="op">-</span><span class="dv">1</span>)].values[<span class="dv">0</span>]<span class="op">+</span>(<span class="dv">1</span><span class="op">-</span>Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>])<span class="op">*</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(PanelFIT[group1]<span class="op">+</span>Subsidy2)</span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Cumulative profit of agents in group 2 is initialised as capacity of panel times FIT</span></span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>    CumulativeProfit[group2]<span class="op">=</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(PanelFIT[group2]<span class="op">+</span>Subsidy2)</span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Cumulative profit of agents in group 3 is initialised as minimum between share of own consumption times capacity of the panel and electricity consumption times initial electricity price plus remaining capacity times FIT</span></span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>    CumulativeProfit[group3]<span class="op">=</span>np.minimum(Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>]<span class="op">*</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>],Powercost_f[group3])<span class="op">*</span>PriceEmp[<span class="bu">str</span>(start<span class="op">-</span><span class="dv">1</span>)].values[<span class="dv">0</span>]<span class="op">+</span>(PanelFIT[group3]<span class="op">+</span>Subsidy2)<span class="op">*</span>(Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">-</span>np.minimum(Params[<span class="st">"PVCons"</span>].values[<span class="dv">0</span>]<span class="op">*</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>],Powercost_f[group3]))</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Cumulative profit of agents in group 4 is initialised as capacity of panel times FIT</span></span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>    CumulativeProfit[group4]<span class="op">=</span>Params[<span class="st">"PVCapacity"</span>].values[<span class="dv">0</span>]<span class="op">*</span>(PanelFIT[group4]<span class="op">+</span>Subsidy2)</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>    <span class="co">#For simplicity, assume that agents earned this profit in all previous periods</span></span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>    CumulativeProfit<span class="op">=</span>CumulativeProfit<span class="op">*</span>PanelAge</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Subtract from cumulative profit the cost of PV from the year in which it was installed</span></span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> a <span class="kw">in</span> <span class="bu">range</span>(maxage<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>        yearadopted<span class="op">=</span>start<span class="op">-</span>(a<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">sum</span>(<span class="bu">str</span>(yearadopted)<span class="op">==</span>PVCost.columns)<span class="op">==</span><span class="dv">1</span>:</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>            CumulativeProfit[(PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (PanelAge<span class="op">==</span>a)]<span class="op">=</span>CumulativeProfit[(PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (PanelAge<span class="op">==</span>a)]<span class="op">-</span>(<span class="dv">1</span><span class="op">-</span>Subsidy1)<span class="op">*</span>PVCost[<span class="bu">str</span>(yearadopted)].values[<span class="dv">0</span>]</span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>        <span class="co">#If a panel is older than the earliest available value for panel cost, use the earliest value</span></span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>            CumulativeProfit[(PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (PanelAge<span class="op">==</span>a)]<span class="op">=</span>CumulativeProfit[(PV[:,<span class="dv">0</span>]<span class="op">==</span><span class="dv">1</span>) <span class="op">&amp;</span> (PanelAge<span class="op">==</span>a)]<span class="op">-</span>(<span class="dv">1</span><span class="op">-</span>Subsidy1)<span class="op">*</span>PVCost.iloc[<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Initialise aggregate statistics</span></span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>    AverageIncome<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>    AverageLiquidity<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>    AverageExpectedPrice<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>    AverageDebt<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>    AdoptionRate1<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>    AdoptionRate2<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>    AdoptionRateDeciles<span class="op">=</span>np.zeros(((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>),<span class="dv">10</span>))</span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>    ChangeAdoptionRate1<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a>    ChangeAdoptionRate2<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>    RationedShare<span class="op">=</span>np.zeros((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>))</span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Generate two electricity price time-series</span></span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>    PriceReturn<span class="op">=</span>GenerateElectricityPrice(_PriceEmp<span class="op">=</span>PriceEmp.copy(),_Params<span class="op">=</span>Params.copy(),_length<span class="op">=</span>(end<span class="op">-</span>start<span class="op">+</span><span class="dv">3</span>),_start<span class="op">=</span>start)</span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Price series to be used in the simulation</span></span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>    Price<span class="op">=</span>PriceReturn[<span class="dv">0</span>]</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Price series used to train agents' expectations formation</span></span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>    PriceTrain<span class="op">=</span>PriceReturn[<span class="dv">1</span>]</span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Use PriceTrain to train agents' expectations formation using a number of time-steps equal to the length of the actual simulation</span></span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> period <span class="kw">in</span> <span class="bu">range</span>((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)):</span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>        ExpectationReturn<span class="op">=</span>FormExpectation(_ARPars<span class="op">=</span>ARPars.copy(),_ARMats<span class="op">=</span>ARMats.copy(),_Price<span class="op">=</span>PriceTrain.copy(),_Gain<span class="op">=</span>Gain.copy(),_ExpectedPrice<span class="op">=</span>ExpectedPrice.copy(),_period<span class="op">=</span>period)</span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a>        ARMats<span class="op">=</span>ExpectationReturn[<span class="dv">0</span>]</span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>        ARPars<span class="op">=</span>ExpectationReturn[<span class="dv">1</span>]</span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>        ExpectedPrice<span class="op">=</span>ExpectationReturn[<span class="dv">2</span>]</span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Enter main model loop</span></span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Set the current year to the start year supplied to the function</span></span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a>    year<span class="op">=</span>start</span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> period <span class="kw">in</span> <span class="bu">range</span>((end<span class="op">-</span>start<span class="op">+</span><span class="dv">1</span>)):</span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set the purchase and installation cost of a solar panel equal to the value for the current year</span></span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>        Params[<span class="st">"PanelCost"</span>]<span class="op">=</span>PVCost[<span class="bu">str</span>(year)].values[<span class="dv">0</span>]</span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set starting value for liquid wealth and PV equal to closing value from last period</span></span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> period<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>            Liquidity[:,period]<span class="op">=</span>Liquidity[:,(period<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>            PV[:,period]<span class="op">=</span>PV[:,(period<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Set policy variables</span></span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>        PolicyReturn<span class="op">=</span>SetPolicy(_Subsidy1<span class="op">=</span>Subsidy1,_Subsidy2<span class="op">=</span>Subsidy2,_CreditPolicy1<span class="op">=</span>CreditPolicy1,_CreditPolicy2<span class="op">=</span>CreditPolicy2,_year<span class="op">=</span>year,_Params<span class="op">=</span>Params.copy())</span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>        Subsidy1<span class="op">=</span>PolicyReturn[<span class="dv">0</span>]</span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a>        Subsidy2<span class="op">=</span>PolicyReturn[<span class="dv">1</span>]</span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>        CreditPolicy1<span class="op">=</span>PolicyReturn[<span class="dv">2</span>]</span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a>        CreditPolicy2<span class="op">=</span>PolicyReturn[<span class="dv">3</span>]</span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Calculate income and electricity cost</span></span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>        IncomePowercostReturn<span class="op">=</span>IncomePowercost(_Income_f<span class="op">=</span>Income_f.copy(),_Trend<span class="op">=</span>Trend.copy(),_Powercost_f<span class="op">=</span>Powercost_f.copy(),_Income_sd<span class="op">=</span>Income_sd.copy(),_CumulativeProfit<span class="op">=</span>CumulativeProfit.copy(),_PV<span class="op">=</span>PV[:,period].copy(),_Price<span class="op">=</span>Price[(period<span class="op">+</span><span class="dv">2</span>)].copy(),_PanelFIT<span class="op">=</span>PanelFIT.copy(),_Subsidy2<span class="op">=</span>Subsidy2,_Params<span class="op">=</span>Params.copy())</span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>        Income[:,period]<span class="op">=</span>IncomePowercostReturn[<span class="dv">0</span>]</span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a>        Powercost[:,period]<span class="op">=</span>IncomePowercostReturn[<span class="dv">1</span>]</span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a>        Income_p[:,period]<span class="op">=</span>IncomePowercostReturn[<span class="dv">2</span>]</span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a>        CumulativeProfit[:]<span class="op">=</span>IncomePowercostReturn[<span class="dv">3</span>]</span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a>        Income_f[:]<span class="op">=</span>IncomePowercostReturn[<span class="dv">4</span>]</span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a>        Powercost_f[:]<span class="op">=</span>IncomePowercostReturn[<span class="dv">5</span>]</span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Calculate income distribution statistics</span></span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a>        IncomeGroupReturn<span class="op">=</span>IncomeGroups(_Income_p<span class="op">=</span>Income_p[:,period].copy(),_Positions_p<span class="op">=</span>Positions_p.copy(),_Percentiles<span class="op">=</span>Percentiles.copy(),_Positions_d<span class="op">=</span>Positions_d.copy(),_Deciles<span class="op">=</span>Deciles.copy(),_IncomePercentiles<span class="op">=</span>IncomePercentiles.copy(),_IncomeDeciles<span class="op">=</span>IncomeDeciles.copy())</span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a>        IncomePercentiles[:]<span class="op">=</span>IncomeGroupReturn[<span class="dv">0</span>]</span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a>        IncomeDeciles[:]<span class="op">=</span>IncomeGroupReturn[<span class="dv">1</span>]</span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a>        <span class="co">#In first simulation period, initialise PV ownership by decile</span></span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> period<span class="op">==</span><span class="dv">0</span>:</span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a>            PVDecileReturn<span class="op">=</span>PVDeciles(_Income_p<span class="op">=</span>Income_p[:,period].copy(),_PV<span class="op">=</span>PV[:,period].copy(),_Positions_d<span class="op">=</span>Positions_d.copy(),_PVOwnershipDeciles<span class="op">=</span>PVOwnershipDeciles.copy(),_Deciles<span class="op">=</span>Deciles.copy(),_DecileMembers<span class="op">=</span>DecileMembers.copy())</span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a>            PVOwnershipDeciles[:]<span class="op">=</span>PVDecileReturn[<span class="dv">0</span>]</span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Calculate consumption and saving</span></span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a>        ConsumptionSavingReturn<span class="op">=</span>ConsumptionSaving(_Income_p<span class="op">=</span>Income_p[:,period].copy(),_Propensities<span class="op">=</span>Propensities.copy(),_IncomePercentiles<span class="op">=</span>IncomePercentiles.copy(),_Consumption<span class="op">=</span>Consumption.copy(),_Income<span class="op">=</span>Income[:,period].copy(),_Powercost<span class="op">=</span>Powercost[:,period].copy(),_Liquidity<span class="op">=</span>Liquidity[:,period].copy(),_Debt<span class="op">=</span>Debt.copy(),_DebtService<span class="op">=</span>DebtService.copy(),_LoanRate<span class="op">=</span>LoanRate.copy(),_PanelAge<span class="op">=</span>PanelAge.copy(),_CumulativeProfit<span class="op">=</span>CumulativeProfit.copy(),_LiquidityShares<span class="op">=</span>LiquidityShares.copy(),_Params<span class="op">=</span>Params.copy(),_period<span class="op">=</span>period)</span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a>        Liquidity[:,period]<span class="op">=</span>ConsumptionSavingReturn[<span class="dv">0</span>]</span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a>        Debt[:]<span class="op">=</span>ConsumptionSavingReturn[<span class="dv">1</span>]</span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a>        DebtService[:]<span class="op">=</span>ConsumptionSavingReturn[<span class="dv">2</span>]</span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a>        LoanRate[:]<span class="op">=</span>ConsumptionSavingReturn[<span class="dv">3</span>]</span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a>        Consumption[:]<span class="op">=</span>ConsumptionSavingReturn[<span class="dv">4</span>]</span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a>        CumulativeProfit[:]<span class="op">=</span>ConsumptionSavingReturn[<span class="dv">5</span>]</span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Increment age of existing panels</span></span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a>        PanelAgeReturn<span class="op">=</span>AugmentPanelAge(_PV<span class="op">=</span>PV[:,period].copy(),_PanelAge<span class="op">=</span>PanelAge.copy(),_PanelFIT<span class="op">=</span>PanelFIT.copy(),_Params<span class="op">=</span>Params.copy())</span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a>        PanelAge<span class="op">=</span>PanelAgeReturn[<span class="dv">0</span>]</span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a>        PV[:,period]<span class="op">=</span>PanelAgeReturn[<span class="dv">1</span>]</span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a>        PanelFIT<span class="op">=</span>PanelAgeReturn[<span class="dv">2</span>]</span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Form expectations</span></span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a>        ExpectationReturn<span class="op">=</span>FormExpectation(_ARPars<span class="op">=</span>ARPars.copy(),_ARMats<span class="op">=</span>ARMats.copy(),_Price<span class="op">=</span>Price.copy(),_Gain<span class="op">=</span>Gain.copy(),_ExpectedPrice<span class="op">=</span>ExpectedPrice.copy(),_period<span class="op">=</span>period)</span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a>        ARMats<span class="op">=</span>ExpectationReturn[<span class="dv">0</span>]</span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a>        ARPars<span class="op">=</span>ExpectationReturn[<span class="dv">1</span>]</span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a>        ExpectedPrice<span class="op">=</span>ExpectationReturn[<span class="dv">2</span>]</span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Adoption decision</span></span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a>        AdoptionReturn<span class="op">=</span>AdoptionDecision(_PV<span class="op">=</span>PV[:,period].copy(),_Feasible<span class="op">=</span>Feasible.copy(),_Liquidity<span class="op">=</span>Liquidity[:,period].copy(),_Rationed<span class="op">=</span>Rationed.copy(),_Debt<span class="op">=</span>Debt.copy(),_Income<span class="op">=</span>Income[:,period].copy(),_Income_f<span class="op">=</span>Income_f.copy(),_Powercost_f<span class="op">=</span>Powercost_f.copy(),_Trend<span class="op">=</span>Trend.copy(),_ExpectedPrice<span class="op">=</span>ExpectedPrice.copy(),_Discount<span class="op">=</span>Discount.copy(),_Revenue<span class="op">=</span>Revenue.copy(),_LoanCost<span class="op">=</span>LoanCost.copy(),_PVOwnershipDeciles<span class="op">=</span>PVOwnershipDeciles.copy(),_IncomeDeciles<span class="op">=</span>IncomeDeciles.copy(),_LoanRate<span class="op">=</span>LoanRate.copy(),_DebtService<span class="op">=</span>DebtService.copy(),_Influence<span class="op">=</span>Influence.copy(),_Attitude<span class="op">=</span>Attitude.copy(),_Adopted<span class="op">=</span>Adopted.copy(),_CumulativeProfit<span class="op">=</span>CumulativeProfit.copy(),_FIT<span class="op">=</span>FIT.copy(),_year<span class="op">=</span>year,_PanelFIT<span class="op">=</span>PanelFIT.copy(),_Baserate<span class="op">=</span>Baserate.copy(),_Subsidy1<span class="op">=</span>Subsidy1,_Subsidy2<span class="op">=</span>Subsidy2,_CreditPolicy1<span class="op">=</span>CreditPolicy1,_CreditPolicy2<span class="op">=</span>CreditPolicy2,_Params<span class="op">=</span>Params.copy())</span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a>        PV[:,period]<span class="op">=</span>AdoptionReturn[<span class="dv">0</span>]</span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a>        Rationed[:]<span class="op">=</span>AdoptionReturn[<span class="dv">1</span>]</span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a>        Liquidity[:,period]<span class="op">=</span>AdoptionReturn[<span class="dv">2</span>]</span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a>        LoanRate[:]<span class="op">=</span>AdoptionReturn[<span class="dv">3</span>]</span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a>        Debt[:]<span class="op">=</span>AdoptionReturn[<span class="dv">4</span>]</span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a>        DebtService[:]<span class="op">=</span>AdoptionReturn[<span class="dv">5</span>]</span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a>        Adopted[:]<span class="op">=</span>AdoptionReturn[<span class="dv">6</span>]</span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a>        CumulativeProfit[:]<span class="op">=</span>AdoptionReturn[<span class="dv">7</span>]</span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a>        PanelFIT[:]<span class="op">=</span>AdoptionReturn[<span class="dv">8</span>]</span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Calculate aggregate statistics</span></span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a>        StatisticsReturn<span class="op">=</span>CalculateStatistics(_PV<span class="op">=</span>PV[:,period].copy(),_Income<span class="op">=</span>Income[:,period].copy(),_Debt<span class="op">=</span>Debt.copy(),_Liquidity<span class="op">=</span>Liquidity[:,period].copy(),_ExpectedPrice<span class="op">=</span>ExpectedPrice[:,<span class="dv">0</span>].copy(),_Feasible<span class="op">=</span>Feasible.copy(),_Rationed<span class="op">=</span>Rationed.copy())</span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a>        AverageIncome[period]<span class="op">=</span>StatisticsReturn[<span class="dv">0</span>]</span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a>        AverageLiquidity[period]<span class="op">=</span>StatisticsReturn[<span class="dv">1</span>]</span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a>        AverageExpectedPrice[period]<span class="op">=</span>StatisticsReturn[<span class="dv">2</span>]</span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a>        AverageDebt[period]<span class="op">=</span>StatisticsReturn[<span class="dv">3</span>]</span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a>        AdoptionRate1[period]<span class="op">=</span>StatisticsReturn[<span class="dv">4</span>]</span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a>        AdoptionRate2[period]<span class="op">=</span>StatisticsReturn[<span class="dv">5</span>]</span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a>        RationedShare[period]<span class="op">=</span>StatisticsReturn[<span class="dv">6</span>]</span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Calculate change in adoption rates</span></span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> period<span class="op">&gt;</span><span class="dv">0</span>:</span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a>            ChangeAdoptionRate1[period]<span class="op">=</span>AdoptionRate1[period]<span class="op">-</span>AdoptionRate1[(period<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a>            ChangeAdoptionRate2[period]<span class="op">=</span>AdoptionRate2[period]<span class="op">-</span>AdoptionRate2[(period<span class="op">-</span><span class="dv">1</span>)]</span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Calculate PV ownership rate by decile    </span></span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a>        PVDecileReturn<span class="op">=</span>PVDeciles(_Income_p<span class="op">=</span>Income_p[:,period].copy(),_PV<span class="op">=</span>PV[:,period].copy(),_Positions_d<span class="op">=</span>Positions_d.copy(),_PVOwnershipDeciles<span class="op">=</span>PVOwnershipDeciles.copy(),_Deciles<span class="op">=</span>Deciles.copy(),_DecileMembers<span class="op">=</span>DecileMembers.copy())</span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a>        PVOwnershipDeciles[:]<span class="op">=</span>PVDecileReturn[<span class="dv">0</span>]</span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a>        AdoptionRateDeciles[period]<span class="op">=</span>PVOwnershipDeciles</span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a>        <span class="co">#Increment year</span></span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a>        year<span class="op">=</span>year<span class="op">+</span><span class="dv">1</span></span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a>    <span class="co">#Save aggregate statistics and ownership rates by decile</span></span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a>    Stats<span class="op">=</span>np.column_stack((AverageIncome,AverageLiquidity,AverageExpectedPrice,AverageDebt,AdoptionRate1,AdoptionRate2,ChangeAdoptionRate1,ChangeAdoptionRate2,RationedShare,Price[<span class="dv">2</span>:<span class="bu">len</span>(Price)]))</span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a>    Stats<span class="op">=</span>pd.DataFrame(data<span class="op">=</span>Stats,columns<span class="op">=</span>[<span class="st">"AverageIncome"</span>,<span class="st">"AverageLiquidity"</span>,<span class="st">"AverageExpectedPrice"</span>,<span class="st">"AverageDebt"</span>,<span class="st">"AdoptionRate1"</span>,<span class="st">"AdoptionRate2"</span>,<span class="st">"ChangeAdoptionRate1"</span>,<span class="st">"ChangeAdoptionRate2"</span>,<span class="st">"RationedShare"</span>,<span class="st">"Price"</span>])</span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a>    Stats_m<span class="op">=</span>pd.DataFrame(data<span class="op">=</span>AdoptionRateDeciles,columns<span class="op">=</span>[<span class="st">"1"</span>,<span class="st">"2"</span>,<span class="st">"3"</span>,<span class="st">"4"</span>,<span class="st">"5"</span>,<span class="st">"6"</span>,<span class="st">"7"</span>,<span class="st">"8"</span>,<span class="st">"9"</span>,<span class="st">"10"</span>])</span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a>    filename<span class="op">=</span><span class="st">'outputSolar/out_'</span></span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a>    filename<span class="op">+=</span>runname</span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a>    filename<span class="op">+=</span><span class="st">"_"</span></span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a>    filename<span class="op">+=</span><span class="bu">str</span>(seed)</span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a>    filename<span class="op">+=</span><span class="st">'.csv'</span></span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a>    filename2<span class="op">=</span><span class="st">'outputSolar/out_deciles_'</span></span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a>    filename2<span class="op">+=</span>runname</span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a>    filename2<span class="op">+=</span><span class="st">"_"</span></span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a>    filename2<span class="op">+=</span><span class="bu">str</span>(seed)</span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a>    filename2<span class="op">+=</span><span class="st">'.csv'</span></span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a>    Stats.to_csv(filename)</span>
<span id="cb11-282"><a href="#cb11-282" aria-hidden="true" tabindex="-1"></a>    Stats_m.to_csv(filename2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
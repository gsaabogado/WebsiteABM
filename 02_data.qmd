---
title: "Data"
author: "Severin Reissl and Luis Sarmiento"
bibliography: Literature.bib
format: 
  html: 
    toc: true
    warning: false
    code-fold: true
    code-summary: "Show the Code"
    fontsize: "15px"
---

```{r}
#| echo: false
conflict_prefer("filter", "dplyr")
```

In this section we describe at length the main characteristics and scientific processing of the data files we use in the ABM-REN model.

The section is divided into three main subsections:

-   German Socio-Economic Panel Study
-   Consumption data from the Deutscher Finanz Amt
-   Gallup data on environmental attitudes

# SOEP

Most of the data we use to feed our model comes from the German Socio-Economic Panel Study (SOEP); a representative longitudinal panel study that started in West Germany in 1984.

Ee use data from SOEP-37 for ABM-REN.

The SOEP is divided into different data files each containing different questionnaires.

The main questionnaires we use for the construction of ABM-REN are:

::: incremental
-   PEQUIV - Personal Equivalent File $\rightarrow$ ([Documentation](https://www.diw.de/de/diw_01.c.839052.de/s_13585.html))
-   HGEN - Household Generated Data File $\rightarrow$ ([Documentation](https://www.diw.de/documents/publikationen/73/diw_01.c.676077.de/diw_ssp0759.pdf))
-   HCONSUM - Household Consumption Module ([Documentation](https://www.econstor.eu/bitstream/10419/85377/1/769362788.pdf))
-   HWEALTH - Household Wealth Questionnaire ([Documentation](https://www.econstor.eu/handle/10419/116767))
:::

## Data Structure

All of our variables are in one of two R formats; numeric or haven-labelled. Haven labelled format is similar to STATA (or SPSS) labelled data (For more information we refer the reader to the [online vignete of the haven package](https://haven.tidyverse.org/articles/semantics.html)).

The R-labelled class (part of the haven package) allows us to associate arbitrary labels to numeric or character vectors. Note that the goal of labelled files is only to include the description of categorical vectors in the SOEP data. For instance, when printing one labelled variable, the output consists of a vector of values and a data frame linking values and labels.

It is essential to clarify that researchers must transform haven-labelled data formats into numeric or factor variables before using them in econometric, machine learning, or optimization models.

We keep the haven-labelled format in the raw files as it allows researchers to directly understand the values related to each numeric identifier of categorical variables in the SOEP data.

As an example, we show the gender-labelled variable. The ouput contains a title identifier *Gender of Individual*, a vector of numeric values (i.e., 2,1,2,1,1,2), and the data frame linking values to labels.

```{r}
#| echo: false
file = gsub("WebsiteABM", "", getwd())
pequiv = read_rds(paste0(file, "02_GenData/03_SoepFiles/pequiv.rds"))
```

```{r}
#| echo: false
# Show the data set
head(pequiv$sex)
```

Also note that, **in general**, all negative entries refer to missing values for different reasons, e.g., the question was not part of that year's questionnaire or invalid answers.

## PEQUIV

@tbl-PequivIndividual shows a sample of individual-level characteristics we extract from the PEQUIV file. It consists of `r ncol(pequiv)` variables and `r comma(nrow(pequiv))` observations between 2005 and 2018. Each variable is either in a numeric or haven-labelled format. The data frame contains the individual and household IDs (*pid* and *hid*). *year* refers to the year of the interview. *head* is an indicator variable on the relationship between *pid* and the household head (1 = head, 2 = partner, 3 = child, 4 = relative, and 5 = non-relative). *age* is the average age. *sex* the gender (1 - Male; 2- Female). And, *education*, the total years of education. @tbl-PequivSpatial includes data on the spatial location of the household. Because we are working with the open version of the SOEP, we can only identify the *state* and *region* where the household is located.

::: panel-tabset
#### Individual

```{r}
#| label: tbl-PequivIndividual
#| tbl-cap: Individual characteristics from the PEQUIV file
#| tbl-cap-location: top
#| echo: true
# Show the data set
kbl(select(pequiv, pid, hid, year, head, sex, age, education) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Spatial

```{r}
#| label: tbl-PequivSpatial
#| tbl-cap: Spatial variables from the PEQUIV file
#| tbl-cap-location: top
#| echo: true
# Show the data set
kbl(select(pequiv, pid, hid, year, state, region) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Employment

```{r}
#| label: tbl-PequivEmployment
#| tbl-cap: Employment variables from the PEQUIV file
#| tbl-cap-location: top
#| echo: true
# Show the data set
kbl(select(pequiv, pid, hid, year, employment, occupation, industry) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Household

```{r}
#| label: tbl-PequivHH
#| tbl-cap: Household variables from the PEQUIV file
#| tbl-cap-location: top
#| echo: true
# Show the data set
kbl(select(pequiv, pid, hid, year, Npersons, Nkids, income, GrossIncome) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```
:::

@tbl-PequivEmployment contains employment-related covariates. *employment* is a dummy variable equal to one if the person is currently employed. *occupation* is the person's occupation according to the International Classification of Occupations Code (ISCO). For instance, code 5,160 refers to protective service workers. *industry* is a two-digit industry code based on ten categories (1 -- Agriculture, 2 -- Energy, 3 -- Mining, 4 -- Manufacturing, 5 -- Construction, 6 -- Trade, 7 -- Transport, 8 -- Bank and Insurance, 9 -- Services).

@tbl-PequivHH includes a set of household-level controls. While *Npersons* and *Nkids* are the number of persons and kids in the household, *income* and *GrossIncome* are the household net and gross income in Euros per year.

## HGEN

```{r}
#| echo: false
file = gsub("WebsiteABM", "", getwd())
hgen = read_rds(paste0(file, "02_GenData/03_SoepFiles/hgen.rds"))
```

@tbl-HgenID shows a sample of household-level identifiers we extract from the HGEN file. The full data-frame contains `r ncol(hgen)` variables and `r comma(nrow(hgen))` observations across `r comma(length(unique(hgen$hid)))` households spanning between 2005 and 2018. *hid* and *year* are analogous to the **pequiv** file.

-   *Owner* is an indicator variable based on four categories (1 -- Owner, 2 -- Main Tenant, 3 -- Sub-Tenant, 4 -- Tenant, 5 -- Living in a home).
-   *FreeRent* is a dummy variable equal to one if the family does not pay rent.
-   *YearMoved* refers to the year the family moved to the household.
-   *HouseSize* Is the size of the dwelling in square meters.

::: panel-tabset
#### Household Indentifiers

```{r}
#| label: tbl-HgenID
#| tbl-cap: Household identifiers HGEN file
#| tbl-cap-location: top
#| echo: true
kbl(select(hgen, hid, year, owner, FreeRent, YearMoved, HouseSize) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Household Infrastructure

```{r}
#| label: tbl-HgenInf
#| tbl-cap: Household identifiers HGEN file
#| tbl-cap-location: top
#| echo: true
kbl(select(hgen, hid, year, basement, garden, elevator, balcony) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Household Energy

```{r}
#| label: tbl-HgenRen
#| tbl-cap: Household energy efficiency investments
#| tbl-cap-location: top
#| echo: true
kbl(select(hgen, hid, year, CentralFloorHeating, ThermalInsulation, DoubleGlazing, AlternativeEnergy, pv, boiler) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Household Costs

```{r}
#| label: tbl-HgenCosts
#| tbl-cap: Household energy costs
#| tbl-cap-location: top
#| echo: true
kbl(select(hgen, hid, year, PowerCosts, OtherUtilityCosts, GasCosts, WarmWaterCosts) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```
:::

@tbl-HgenInf contains different infrastructure characteristics of the dwelling. All variables are indicator dummies of basement, garden, elevator, or balcony infrastructure.

@tbl-HgenRen includes a set of indicator variables regarding household investments in Energy infrastructure or appliances. The indicator variables come from answers to the question **What amenities does your dwelling have? Does it have -** central floor heating (*CentralFloorHeating - 1984-2014*), floor heating (*FloorHeating - since 2014*), thermal insulation in the facade, roof, or basement (*ThermalInsulation - Since 2015*), air conditioner (*ac - Since 2007*), solar energy system (*pv - Since 2007*), other alternative energy sources like geothermal or heat pump (*AlternativeEnergy - Since 2009*), boiler (*boiler - 1991-2013*), or windows with at least double glazing (*DoubleGlazing - Since 2015*).

@tbl-HgenCosts includes a set of numeric variables on the household's energy costs:

-   *WarmWaterCost*: contains the heating costs of tenants. The number comes from answers to the question **What were the heating costs, including hot water, in the last calendar year?**. Until 2013 (wave BD), the SOEP only surveyed heating costs for tenants. After 2013, it asked all SOEP individuals. In 2015 (wave BF), respondents stated their costs for different energy sources (district heating, gas, liquefied gas, electricity, heating oil, coal, wood, biomass, solar, and geothermal) and whether they used them for heating, warm water, cooking, or electronic devices. This change decreased the *WarmWaterCost* variable in the BF wave vs. other years.
-   *PowerCosts*: is a numeric variable with the electricity costs (excluding heating when applicable) asked since 2010. The exact questionnaire question is; **What were your electricity costs in the last calendar year?** The SOEP only asks this question to tenants if they pay rent. However, from 2016, it asked all tenants whether they paid rent or not.
-   *GasCosts*: states the monthly costs of gas not used for heating in Euros. Gas costs were only collected in 2014 (wave BE).
-   *OtherUtilityCosts*: are answers to the question; how much did you pay in the last calendar year for water, garbage removal, street cleaning, and other additional costs not mentioned above?

## HCONSUM

### Introduction

We use the 2010 SOEP consumption module to estimate the consumption propensity of German households. The SOEP consumption module, or "hconsum," was implemented as part of the 31st SOEP wave in 2010. The goal of *hconsum* is to allow researchers to understand the relationship between welfare, income, and disposable income -- whereas consumption characterizes the actual current living standard, income describes the potential command over resources. For a complete review of the SOEP consumption module, we refer the reader to @Grabka2013. In this chapter, we only highlight the its main characteristics.

Usually, consumption data takes one of two forms; consumption journals or representative surveys. The goal of consumption journals is to keep track of all daily expenditures across a cross-section of representative households to understand consumption patterns. Once there is enough data, researchers aggregate the items into categories to assess the main components of households' income use. . Representative surveys, on the other hand, study typical consumption instead of consumption at a given time. The core idea is that asking for a relevant set of common consumption goods can act as a good proxy for total consumption.

In the 2010 hconsum module, the SOEP adopted the idea of consumption goods to approximate total consumption. In total, they collected twenty-four different consumption categories spanning from food expenditures to insurance costs.

There were a series of methodological challenges while collecting the consumption data. First, there were inconsistencies between reported monthly and yearly expenditures. In total, the share of inconsistencies is smaller than one percent. Next, there were missing values (usually around 2-4%) across several categories. Finally, there was clear evidence of heaping (coarse reporting of continuous values).

The SOEP solves the inconsistency between monthly and yearly data with the following process. First, it computes the percentiles of consumption according to the reported monthly and annual values. Second, compare this percentage rank to the percentiles of the household net income. In case of inconsistent monthly and yearly information, the SOEP assigns the consumption value of the category whose percentile is the closest to the income distribution.

For missing data, the SOEP uses multiple imputation methods. However, instead of assigning only one value per income category, the SOEP assign five different values to reflect the uncertainty in the imputation process. Particularly, the SOEP impute the missing values through multivariate imputation by chained equations (MICE) [@VanBuren1999].

For heaping, the SOEP adjust the heaped data by approximating its true distribution with an theoretical distribution of consumption behaviour. After several theoretical exercise, the SOEP chooses the gamma and generalized beta distribution of the second kind (GB2) to approximate the true distribution of consumption data. @eq-gb2 contains the mathematical formula behind the GB2 distribution. In it, $x$ is consumption, $B(b,q)$ the beta function, and a,b,p, and q positive parameters.

$$
f(x) = ax^{ap-1}\Big[b^{ab} B(p,q)\Big(1 + (\frac{x}{b})^a\Big)^{p+q}\Big]^{-1}
$$ {#eq-gb2}

```{r}
#| echo: false
file = gsub("WebsiteABM", "", getwd())
data = read_rds(paste0(file, "02_GenData/03_SoepFiles/hconsum.rds"))
codebook = read_excel(paste0(file, "01_RawData/03_codebooks/codebook.xlsx"), sheet = "hconsum2")
```

In @tbl-ConsA, we show a sample of the consumption data for daily expenditures. @tbl-ConsB contains a similar exercise for housing costs, @tbl-ConsC for financial burdens, and @tbl-ConsD for other income uses. All values are in thousand of Euros per year and come from averaging the five different imputations of the SOEP consumption module across categories.

::: panel-tabset
#### Daily Expenditures

```{r}
#| label: tbl-ConsA
#| tbl-cap: Sample of the consumption module (daily expenditures)
#| tbl-cap-location: top
#| echo: true
kbl(data |> select(hid, Food, Clothes, Transport, Coms, Leisure, Cleaning) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Housing expenditures

```{r}
#| label: tbl-ConsB
#| tbl-cap: Sample of the consumption module (Housing)
#| tbl-cap-location: top
#| echo: true
kbl(data |> select(hid, Rent, Mortgage, Housing, Heating, Power, Utilities, Furniture) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Financial expenditures

```{r}
#| label: tbl-ConsC
#| tbl-cap: Sample of the consumption module (Housing)
#| tbl-cap-location: top
#| echo: true
kbl(data |> select(hid, Insurance, Loans, Mortgage) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Other expenditures

```{r}
#| label: tbl-ConsD
#| tbl-cap: Sample of the consumption module (Other)
#| tbl-cap-location: top
#| echo: true
kbl(data |> select(hid, Alimony, ChildCare, Culture, Education, Health, Holidays, Other) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```
:::

In @fig-ShareConsumption, we look at the difference in consumption values and composition across the SOEP income deciles. For this, we aggregate all consumption items into eight categories; Daily expenditures, health, financial, transport, heating, power, housing, and others. There are apparent differences in the amount of money used for consumption across income groups. For instance, in the highest and lowest deciles of the income distribution, households spend 14,900 and 4,460 Euros per year, respectively. @fig-ShareConsumption portrays a clearer picture of the composition of these expenditures across income groups. While the share of financial and health costs grows with income, heating and power expenditures decrease. @fig-HeatCon clearly shows these trends with a heat map of consumption category by income decile. The expenditure share of housing, daily expenses, and health remains relatively stable; financial, transport and health costs increase with income; and heating-power expenses decrease. In @fig-IncToCon, we plot the ratio of average income to consumption by income decile. As expected, the consumption income ratio drops as we become more well-off. In the lowest income decile, families spend, on average, 34% more than their average income, meaning that they either live from debt or receive additional and unreported income from other sources. Once we move to the second income decile, the ratio reaches parity and implies that persons in this decile earn as much as they spend. Finally, in @fig-IncToConHeat, we plot the heat map of consumption income ratios across different categories.

### Descriptives

::: panel-tabset
##### Consumption

```{r}
#| label: fig-RawConsumption
#| fig-cap: Yearly consumption by concept in thousand euros (SOEP 2010)
#| fig-cap-location: top
#| echo: true

# Divide into income deciles 
data = mutate(data, decile = ntile(income, 10)) |> 
  mutate(decile = as_factor(decile))
# Create the data for the plot
plot= select(data, -total, -income, -owner) %>% 
  gather(var, value, -hid, -decile)%>% 
  left_join(., codebook, by = c("var" = "concept")) |> 
  group_by(decile, group) |> 
  summarise(value = mean(value)) |> 
  mutate(group = fct_reorder(factor(group), value, .desc = F)) |> 
  group_by(decile) |> mutate(total = sum(value))
# Plot total expenditures by concept
ggplot(plot) +
  geom_bar(aes(x = decile, y = value, fill = group), stat = "identity") +
  scale_fill_viridis(discrete = T, option = "E") +
  theme_economist() %+replace% theme(legend.title = element_blank()) +
  labs(x = "Income Decile", y = "")
```

##### Con. Share

```{r}
#| label: fig-ShareConsumption
#| fig-cap: Consumption share by concept (SOEP 2010)
#| fig-cap-location: top
#| echo: true

# Divide into income deciles 
data = mutate(data, decile = ntile(income, 10)) |> 
  mutate(decile = as_factor(decile))
# Create the data for the plot
plot = select(data, -total, -income, -owner) %>% 
  gather(var, value, -hid, -decile) %>% 
  left_join(., codebook, by = c("var" = "concept")) |> group_by(decile, group) |> 
  summarise(value = mean(value)) |> group_by(decile) |> 
  mutate(share = (value/sum(value))*100)  |> 
  mutate(group = fct_reorder(factor(group), share, .desc = F))
# Plot total expenditures by concept
ggplot(plot) +
  geom_bar(aes(x = decile, y = share, fill = group), stat = "identity") +
  scale_fill_viridis(discrete = T, option = "E") +
  theme_economist() %+replace% theme(legend.title = element_blank()) +
  labs(x = "", y = "")
```

##### Con. Matrix

```{r}
#| label: fig-HeatCon
#| fig-cap: Share of total consumption across categories
#| fig-cap-location: top
#| echo: true

# Divide into income deciles 
data = mutate(data, decile = ntile(income, 10)) |> 
  mutate(decile = as_factor(decile))
# Create the data for the plot
plot = select(data, -total, -income, -owner) %>% 
  gather(var, value, -hid, -decile) %>% 
  left_join(., codebook, by = c("var" = "concept")) |> group_by(decile, group) |> 
  summarise(value = mean(value)) |> group_by(decile) |> 
  mutate(share = (value/sum(value))*100)  |> 
  mutate(group = fct_reorder(factor(group), share, .desc = F))
# Plot total expenditures by concept
ggplot(plot) +
  geom_tile(aes(x = decile, y = group, fill = share), alpha = 0.75) +
  geom_text(aes(x = decile, y = group, label = paste0(round(share, 1), "%"))) +
  scale_fill_viridis(discrete = F, begin = 0, end = 0.6, option = "D") +
  theme_economist() %+replace% theme(legend.title = element_blank()) +
  labs(x = "", y = "") + guides(fill = "none")
```

##### Con/Income

```{r}
#| label: fig-IncToCon
#| fig-cap: Consumption share of income (SOEP 2010)
#| fig-cap-location: top
#| echo: true

# Divide into income deciles 
data = mutate(data, decile = ntile(income, 10)) |> 
  mutate(decile = as_factor(decile))
# Create the data for the plot
plot = select(data, total, income, decile) |> 
  group_by(decile) |> 
  summarise(consumption = mean(total), income = mean(income)) |> 
  mutate(share = (consumption/income)*100)
# Plot total expenditures by concept
ggplot(plot) +
  geom_bar(aes(x = decile, y = share, fill = share), stat = "identity") +
  geom_text(aes(x = decile, y = share, label = paste0(round(share,1), "%")), vjust = -0.5) +
  scale_fill_viridis(discrete = F, option = "E", direction = -1) +
  theme_economist() + guides(fill = "none") +
  labs(x = "", y = "")  
```

##### Con/Income matrix

```{r}
#| label: fig-IncToConHeat
#| fig-cap: Consumption share of income across categories
#| fig-cap-location: top
#| echo: true

# Divide into income deciles 
data = mutate(data, decile = ntile(income, 10)) |> 
  mutate(decile = as_factor(decile))
# Create the data for the plot
plot = select(data, -total, -owner) %>% 
  gather(var, value, -hid, -decile, -income) %>% 
  left_join(., codebook, by = c("var" = "concept")) |> group_by(decile, group, var) |> 
  summarise(value = mean(value, na.rm = T), income = mean(income, na.rm = T)) |> 
  group_by(decile, group, income) |> summarise(total = sum(value)) |> group_by(decile, group) |> 
  mutate(share = (total/income)*100)  |> 
  mutate(group = fct_reorder(factor(group), total, .desc = T))

# Plot total expenditures by concept
ggplot(plot) +
  geom_tile(aes(x = decile, y = reorder(group, share), fill = share), alpha = 0.75) +
  geom_text(aes(x = decile, y = group, label = paste0(round(share, 1), "%"))) +
  scale_fill_viridis(discrete = F, begin = 0, end = 0.6, option = "D") +
  theme_economist() %+replace% theme(legend.title = element_blank()) +
  labs(x = "", y = "") + guides(fill = "none")
```
:::

## HWEALTH

### Introduction

The SOEP collected wealth data in 2002, 2007, 2012, and 2017 through the HWEALTH module.

Compared to pure demographic variables, wealth data often contains high nonresponse rates. The SOEP adjusts for missing data with logical and multiple imputations. In 2002, the SOEP surveyed nine asset and liability components; owner-occupied housing, other property, financial assets, business assets, tangible assets, private pensions, mortgage debts, and consumer credits. While in 2002, the Item *private pensions and life insurances* included building loan contracts, the SOEP separated the question from 2007. In 2017, the SOEP added two wealth components, the value of vehicles and student loans. However, other assets are missing, e.g., cash, livestock and crops, equipment, intangible assets, claims against private insurance, and commercial loans.

@tbl-WealthA contains a sample of the HWEALTH module aggregate wealth measures. These are, *GrossWealth* *GrossDebts*, and *NetWealth*. For each element, there are two distinct columns. The column with the number two at the end corresponds to wealth values considering vehicles and student loans. The one without the suffix only considers the wealth of the nine assets surveyed since 2002.

@tbl-WealthB shows a sample of property wealth. While the column without the number two at the end corresponds to owner-occupied housing, the column with a two at the end refers to other properties. As with the previous table, it is possible to separate property values into gross, debt, and net.

```{r}
#| echo: false
file = gsub("WebsiteABM", "", getwd())
data = read_rds(paste0(file, "02_GenData/03_SoepFiles/hwealth.rds"))
```

::: panel-tabset
#### Total Wealth

```{r}
#| label: tbl-WealthA
#| tbl-cap: Sample of the wealth module (Totals)
#| tbl-cap-location: top
#| echo: true
kbl(data |> select(c(hid, year, GrossWealth:NetWealth2)) %>% arrange(-year, hid) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Properties

```{r}
#| label: tbl-WealthB
#| tbl-cap: Sample of the wealth module (Properties)
#| tbl-cap-location: top
#| echo: true
kbl(data |> select(c(hid, year, HouseRaw:HouseDebt2)) %>% arrange(-year, hid) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Financial

```{r}
#| label: tbl-WealthC
#| tbl-cap: Sample of the wealth module (Financial)
#| tbl-cap-location: top
#| echo: true
kbl(data |> select(c(hid, year, financial, insurances, ConsumerDebt, StudentLoans)) %>% arrange(-year, hid) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Other

```{r}
#| label: tbl-WealthD
#| tbl-cap: Sample of the wealth module (Other)
#| tbl-cap-location: top
#| echo: true
kbl(data |> select(c(hid, year, tangible, business, CarsValue)) %>% arrange(-year, hid) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```
:::

@tbl-WealthC includes financial wealth in the form of financial assets, insurances, consumer debt, and car loans. @tbl-WealthD further portrays other wealth elements as the value of business, vehicles, and tangible assets

@fig-WealthIncome portrays the relationshipo between the income distribution divided by deciles and gross wealth, gross debt, and net wealth. As expected, both wealth and debts increase with income. While, average net wealth for the highest decile is of more than 805,000 Euros (118k of debt) , net wealth for the lowest decile is less than 17,000 euros (2.5k of debt). @fig-WealthAge shows the same relationship for age, in line with the literature, age and wealth exhibit decreasing returns to scale (add cite). Although debts peak for people between 40 and 50, Gross and Net Wealth peak for people between 60 and 70.

In @fig-WealthComp we show the composition of wealth by income decile. The overall wealth structure seems quite constant between the first and ninth deciles. However, for the last decile, the wealth composition changes by increasing the importance of business and other properties as a share of total wealth.

### Descriptives

::: panel-tabset
##### Wealth and Income

```{r}
#| label: fig-WealthIncome
#| fig-cap: Relationship between income and total wealth
#| fig-cap-location: top
#| echo: true
# Create the data for the plot
data = mutate(ungroup(data), decile = ntile(income, 10)) |> 
  mutate(decile = as_factor(decile))
# Plot 
plot = data |> filter(year == 2017) |> 
  select(decile, `A) Gross Wealth`= GrossWealth, `B) Gross Debt` = GrossDebts, 
         `C) Net Wealth` = NetWealth) %>%
  gather(var, value, -decile) %>%  group_by(decile, var) |> 
  summarise(value = mean(value))
# Plot total expenditures by concept
ggplot(plot) +
  geom_bar(aes(x = decile, y = value/1000, fill = decile), stat = "identity") +
  scale_fill_viridis(discrete = T, option = "E") +
  theme_economist() %+replace% theme(legend.title = element_blank()) +
  labs(x = "", y = "") + facet_wrap(~var) + guides(fill = "none")
```

##### Wealth and Age

```{r}
#| label: fig-WealthAge
#| fig-cap: Relationship betsween age and total wealth
#| fig-cap-location: top
#| echo: true
# Create the data for the plot
data = mutate(ungroup(data), decile = cut2(age, seq(10, 80, 10))) |> 
  mutate(decile = as_factor(decile))
# Plot 
plot = data |> filter(year == 2017) |> 
  select(decile, `A) Gross Wealth`= GrossWealth, `B) Gross Debt` = GrossDebts, 
         `C) Net Wealth` = NetWealth) %>%
  gather(var, value, -decile) %>%  group_by(decile, var) |> 
  summarise(value = mean(value))
# Plot total expenditures by concept
ggplot(plot) +
  geom_bar(aes(x = decile, y = value/1000, fill = decile), stat = "identity") +
  scale_fill_viridis(discrete = T, option = "E") +
  theme_economist() %+replace% theme(legend.title = element_blank(), axis.text.x = element_text(angle = 90)) +
  labs(x = "", y = "") + facet_wrap(~var) + guides(fill = "none")
```

##### Wealth Composition

```{r}
#| label: fig-WealthComp
#| fig-cap: Composition of wealth by income decile
#| fig-cap-location: top
#| echo: true
data = mutate(ungroup(data), decile = ntile(income, 10)) |> 
  mutate(decile = as_factor(decile))
# Create the data for the plot
plot = data |>  filter(year == 2017) |> 
  select(-c(GrossWealth:NetWealth2, HouseRaw, age, year, 
            HouseRaw2, HouseDebt, HouseDebt2, 
            ConsumerDebt, StudentLoans, income)) %>%  
  gather(var, value, -hid, -decile) |> group_by(decile, var) |> 
  summarise(value = mean(value)/1000) |> group_by(decile) |> 
  mutate(share = (value/sum(value))*100)  
# Rename the wealth groups
orig = c("tangible", "business", "CarsValue", "HouseNet2", "insurances", "financial", "HouseNet")
subs = c("Tangible", "Business", "Cars",
         "Other Property", "Insurance", "Financial", "Main Property")
plot = mutate(plot, group = mgsub(var, orig, subs)) |> 
  mutate(group = fct_reorder(factor(group), share, .desc = F))
# Transform from wide to long format 
plot = gather(plot, type, value, -decile, -var, -group) |> 
  mutate(type = mgsub(type, c("value", "share"), c("a) Value in Ths. Euros", "b) Percentage of Net Wealth")))|> 
  mutate(group = fct_reorder(factor(group), value, .desc = F))
# Plot total expenditures by concept
ggplot(plot) +
  geom_bar(aes(x = decile, y = value, fill = str_wrap(group, 15)), stat = "identity") +
  scale_fill_viridis(discrete = T, option = "E") +
  theme_economist() %+replace% 
  theme(legend.title = element_blank(), strip.text = element_text(hjust = 0)) +
  labs(x = "", y = "") + facet_wrap(~type, scales = "free")
```
:::

## Individual panel

```{r}
#| echo: false
file = gsub("WebsiteABM", "", getwd())
soep = read_rds(paste0(file, "02_GenData/03_SoepFiles/RawSoep.rds")) |> ungroup()
```

Once we load the **hgen** and **pequiv** files, we merge them and construct a final panel data of SOEP individuals between 2005 and 2018. The data set contains `r comma(nrow(soep))` observations across `r comma(length(unique(soep$pid)))` individuals and `r comma(length(unique(soep$hid)))` households. On average, each person remains in the panel `r soep |> group_by(pid) |> summarise(count = n()) |> ungroup() |> summarise(round(mean(count),1))` years. The data set contains 57 different variables (each of which is defined in the glossary section).

When merging the household and individual-level data. We perform different checks and create additional variables.

-   Change all missing values from the SOEP formating to R NA format.
-   Transform the indicator variables with *"Ja" or "Nein" structure* to binary dummies.
-   Transform net and gross income (income, GrossIncome) from Euros to Thousand of Euros.
-   Impute the ownership and lodge indicators in cases with missing data if the household does not report moving.
-   Assume that if the dwelling has a garden it is a house.
-   Assume that if the dwelling has an elevator it is a flat.
-   Transform the PV data from one when bought to one if owned.
-   Determine the age of the panel -- **PanelYear**.
-   Simplify the lodge identifier to only "House" or "Flat".

@tbl-SoepA to @tbl-SoepF contain samples of the final individual-evel data across different sets of variables. For instance, @tbl-SoepA shows a sample of the individual-level characteristics, *YearMoved*, *head*, *age*, *sex*, and *education*.

::: panel-tabset
#### Individual covariates

```{r}
#| label: tbl-SoepA
#| tbl-cap: Individual Covariates in the full sample
#| tbl-cap-location: top
#| echo: true
kbl(soep |> select(pid, hid, year, YearMoved, head, age, sex, education) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Employment

```{r}
#| label: tbl-SoepB
#| tbl-cap: Employmenr Covariates in the full sample
#| tbl-cap-location: top
#| echo: true
kbl(soep |> select(pid, hid, year, employment, occupation, income, GrossIncome) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Dwelling

```{r}
#| label: tbl-SoepC
#| tbl-cap: Employmenr Covariates in the full sample
#| tbl-cap-location: top
#| echo: true
kbl(ungroup(soep) |> select(pid, hid, year, owner, FreeRent, lodge, NewestConstDate, OldestConstDate) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

## Dwelling Charac.

```{r}
#| label: tbl-SoepD
#| tbl-cap: Dwelling characteristics Covariates in the full sample
#| tbl-cap-location: top
#| echo: true
kbl(ungroup(soep) |> select(pid, hid, year, HouseSize, basement, garden, elevator, balcony) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Energy Efficiency

```{r}
#| label: tbl-SoepE
#| tbl-cap: Energy Efficiency Technologies
#| tbl-cap-location: top
#| echo: true
kbl(ungroup(soep) |> select(pid, hid, year, ac, FloorHeating, CentralFloorHeating, ThermalInsulation, AlternativeEnergy, pv, boiler) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

#### Energy Costs

```{r}
#| label: tbl-SoepF
#| tbl-cap: Energy Efficiency Technologies
#| tbl-cap-location: top
#| echo: true
kbl(ungroup(soep) |> select(pid, hid, year, PowerCosts, OtherUtilityCosts, GasCosts, WarmWaterCosts) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```
:::

# Parameters

## Distribution of power costs by income

Next, we use the information on income and power cost from the sub-set of renters to look at the relationship between annual power costs and income. For this, we divide the data set into ten different income groups based on the deciles of the income distribution and estimate the average and standard deviation of income and power costs in each decile.

@tbl-PowerCostDist contains a sample of the final data. *IncomeGroup* refers to the income decile. *IncAvg* is the average yearly income in thousands of Euros. *PowerCostAvg* is the average yearly power bill in Euros. *IncSD* is the standard deviation of annual income. And *PowerCostSd* the analogous for power costs. @fig-PowerCostsDensity contains the density (Log) function of annual Power Costs across different income deciles. As expected, the density is normally distributed with higher mean values for more wealthy households.

::: panel-tabset
## Data Set

```{r}
#| label: tbl-PowerCostDist
#| tbl-cap: Energy Efficiency Technologies
#| tbl-cap-location: top
#| echo: true
# Load Data
file = gsub("WebsiteABM", "", getwd())
data = read_rds(paste0(file, "02_GenData/03_SoepFiles/IncomePowerDeciles.rds"))
# Show the table
kbl(ungroup(data) %>% head(.)) %>% 
  kable_classic(full_width = T, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```

## Descriptives

![Density function of Power Costs across Income Deciles](99_figures/PowerCostsDensity){#fig-PowerCostsDensity}
:::

## Share of PV adoption

We estimate the period-wise share of PV adoption by income decile by calculating the proportion of households in each decile period with a PV installation. @fig_ProbabilityPV portrays the adoption share across deciles from the first period the SOEP started asking for PV installations (2007) and 2017. The likelihood of adoption grows with both income and time. While the average adoption rate across income deciles in 2007 was 1.3%, it rose slightly above 10% in 2017. Concerning inter-decile differences, on average, 2.27% and 13.32% of households in the lowest and highest income decile have a PV installation. 

```{r}

```


```{r}
#| label: fig-ProbabilityPV
#| fig-cap: Probability of PV adoption across income Deciles
#| fig-cap-location: top
#| fig-width: 7
#| fig-height: 4
#| echo: true
#### Load the data
file = gsub("WebsiteABM", "", getwd())
sum = read_rds(paste0(file, "02_GenData/03_SoepFiles/PvProbability.rds"))

#### Plot the probability of adoption for houses and flats
ggplot(sum) + geom_line(aes(y = prob, x = year, group = IncomeGroup, color = IncomeGroup)) + 
  geom_point(aes(y = prob, x = year, color = IncomeGroup)) + theme_economist() %+replace%
  theme(strip.text = element_text(hjust = 0), legend.title = element_blank()) +
  labs(x = "", y = "") + scale_color_viridis(discrete = T) +
  scale_x_continuous(breaks = pretty_breaks())

```

## Estimating Wealth
We estimate the gross wealth of each households with an ordinary least squares model of gross wealth as a function of income and the age of the household head. The estimation model takes the form:

$$
Wealth_{ht} = \beta Income_{ht} + \gamma Age_{ht} + \epsilon_{ht}
$$

@tbl-WealthEst contains the point estimates and standard errors from the OLS. As expected there is a positive relationship between income, age, and gross wealth.

```{r}
#| label: tbl-WealthEst
#| tbl-cap: Estimates for the relationship between gross wealth income and age
#| tbl-cap-location: top
#| echo: true
#### Read the fitted data 
file = gsub("WebsiteABM", "", getwd())
est = read_rds(paste0(file, "02_GenData/03_SoepFiles/WealthEst.rds"))

#### Transform to a data frame long
est = gather(est |> select(-spec) , var, value) |> 
  mutate(stat = gsub(".*_", "", var)) %>% 
  mutate(var = gsub("_.*", "", var)) %>% 
  spread(., var, value)


kbl(est) %>% 
    kable_classic_2(full_width = F, html_font = "Cambria") %>% 
  kable_styling(bootstrap_option = c("hover"))
```


We test the robustness of our econometric specification by varying the set of controls in the OLS design. Model (1) is our preferred specification with linear controls for income and age. (2) adds quadratic controls for both variables. (3) further includes education as an additional control. (4) includes year fixed effects to account for common temporal shocks across households. Finally, in five we estimate the coefficients from within variation in income by including households fixed effects.

```{r}
#| label: fig-WealthEst
#| fig-cap: Fitted wealth distribution across different OLS models
#| fig-cap-location: top
#| fig-width: 7
#| fig-height: 4
#| echo: true
#### Read the fitted data 
file = gsub("WebsiteABM", "", getwd())
fitted = read_rds(paste0(file, "02_GenData/03_SoepFiles/WealthFitted.rds"))

#### Plot the density funtion ####
plot = gather(fitted, var, value, -c(hid, year, income, age, education, GrossWealth))

#### Make the raw bar plot ####
plot %>% group_by(var) %>% filter(value < quantile(value, p = 0.99, na.rm = T)) %>% ggplot(.) + 
  geom_histogram(aes(value/1000, fill = var), alpha = 0.5, 
                 position =position_dodge2(width = 1.5), binwidth = 100) +
  theme(panel.background = element_blank(), legend.position = "top", 
        axis.line = element_line(), legend.background = element_blank(), 
        legend.title = element_blank()) +
  grids() + scale_fill_viridis_d(option = "D") +
  labs(y = "No. of Households", x = "Wealth in Ths.")
```


# Variables Glossary

### Identifiers

-   ***pid:*** Unique identification for each individual ever surveyed in the SOEP.
-   ***hid:*** Links individuals to the households they were living in at the time of the interview.
-   ***year:*** year of the survey.
-   ***state:*** German state of residence
-   ***region:*** German region of residence

### Individual Characteristics

-   ***head:*** Individual's relationship to household head (1 -- Head, 2 -- Partner, 3 -- Child, 4 -- Relative, 5 -- Non Relative)
-   ***age:*** Age of the individual
-   ***sex:*** Gender of the individual (1 -- Male and 2 -- Female)
-   ***Npersons:*** Number of persons in the household
-   ***Nkids:*** Number of kids in the household
-   ***education:*** Years of education

### Income and Employment

-   ***employment:*** Indicator variable equal to one if the person is employed

-   ***occupation:*** Individual's occupation according to the ISCO-88 occupation code (ISCO = International Classification of Occupations)

-   ***industry:*** Individual's two-digit industry code based on ten categories (1 -- Agriculture, 2 -- Energy, 3 -- Mining, 4 -- Manufacturing, 5 -- Construction, 6 -- Trade, 7 -- Transport, 8 -- Bank and Insurance, 9 -- Services).

-   ***income:*** Household post-government income (after taxes and government transfers for all persons in the household)

-   ***GrossIncome:*** Household pre-government income

### House characteristics

-   ***owner:*** Indicator variable if the person is an owner or renter
-   ***FreeRent:*** Indicator variable if the person does not pay rent
-   ***lodge:*** Categoriacal variable indicating if the person lives in a flat or a house
-   ***NewestConstDate:*** Estimated newest construction date of the dwelling
-   ***OldestConstDate:*** Estimated oldest contruction date of the dwelling
-   ***HouseSize:*** House size in square meters
-   ***Basement:*** Indicator variable if the house has a basement.
-   ***garden:*** Indicator variable if the house has a garden.
-   ***elevator*** Indicator variable if the house has an elevator.
-   ***balcony*** Indicator variable if the house has a balcony.

### Energy appliances

-   ***ac:*** Indicator variable if the dwelling has an AC
-   ***FloorHeating:*** Indicator variable if the dwelling has floor heating.
-   ***CentralFloorHeating:*** Indicator variable if the dwelling has central floor heating.
-   ***ThermalInsulation:*** Indicator variable if the dwelling has thermal insulation.
-   ***AlternativeEnergySource:*** Indicator variable if the dwelling uses alternative energy sources
-   ***pv:*** Indicator variable if the dwelling has a photo-voltaic installation
-   ***boiler*** Indicator variable id the dwelling has a boiler

### Energy Costs

-   ***PowerCosts*** Electricity costs in the last calendar year (only renters)
-   ***WarmWaterCost:*** Heating costs including warm water (2013 backwards only renters)
-   ***GasCosts*** Monthly costs of gas not used for heating in Euros (Only collected in 2014)
-   ***OtherUtilityCosts*** How much did you pay in the last calendar year for water, garbage, street cleaning, and other additional costs not mentioned above?
